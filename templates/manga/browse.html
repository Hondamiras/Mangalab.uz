{# templates/manga/browse.html #}
{% extends "base.html" %}
{% load static %}
{% load cache %}

{% block content %}
<div class="mx-auto px-3 py-6 sm:px-16 flex flex-col">
  {# Sidebar (filtrlar paneli) #}
  {% include "manga/includes/_sidebar_filters.html" %}

  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-10 hidden"></div>

  <main id="mainContent" class="flex flex-col flex-1 transition-all duration-300">
    {# yuqori panel: filtr tugmasi + sort #}
    <div class="sticky top-0 z-10 bg-gray-900/80 backdrop-blur-sm px-4 py-2 flex justify-between items-center rounded-lg border-gray-800">
      <div class="flex items-center gap-3">
        <button class="toggle-filters flex items-center gap-2 text-purple-400 hover:text-purple-300">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
          <span>Filtrlar</span>
        </button>
      </div>

      {# Sort select – GET paramlarni saqlab, faqat sortni almashtiradi #}
      <div class="flex items-center space-x-2">
        <label for="sortSelect" class="sr-only">Saralash</label>
        <select id="sortSelect" class="bg-gray-800 text-white text-sm px-2 py-1 rounded">
          <option value="chapters"   {% if sort == 'chapters' %}selected{% endif %}>Boblar soni</option>
          <option value="title_asc"  {% if sort == 'title_asc' %}selected{% endif %}>Nomi (A–Z)</option>
          <option value="title_desc" {% if sort == 'title_desc' %}selected{% endif %}>Nomi (Z–A)</option>
        </select>
      </div>
    </div>

    {# karta grid #}
    <section class="mt-4">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-white">
          <span class="pb-1 border-b-2 border-purple-500">Barcha Taytlar</span>
        </h2>
      </div>

      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-8 gap-3">
        {% for manga in page_obj %}
        <div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg transform transition-transform hover:scale-[1.03]">
          <a href="{% url 'manga:manga_details' manga.slug %}" class="block">
            <div class="relative aspect-[3/4]">
              <img src="{{ manga.cover_image.url }}" alt="{{ manga.title }}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105">

              {# user_status ni xavfsiz ko‘rsatish #}
              {% with us=manga.user_status.0 %}
                {% if us and us.status %}
                <div class="absolute top-2 left-2">
                  <span class="px-2 py-1 text-xs font-bold rounded-full 
                    {% if us.status == 'planned' %}bg-blue-900 text-blue-300
                    {% elif us.status == 'reading' %}bg-purple-900 text-purple-300
                    {% elif us.status == 'completed' %}bg-green-900 text-green-300
                    {% elif us.status == 'dropped' %}bg-red-900 text-red-300
                    {% elif us.status == 'favorite' %}bg-yellow-900 text-yellow-300
                    {% elif us.status == 'ongoing' %}bg-pink-900 text-pink-300
                    {% endif %}">
                    {{ us.get_status_display }}
                  </span>
                </div>
                {% endif %}
              {% endwith %}

              <div class="absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t from-black to-transparent">
                <h3 class="text-white text-sm font-semibold truncate">{{ manga.title }}</h3>
                <div class="flex justify-between items-center text-xs mt-1">
                  <span class="text-gray-300">{{ manga.type }}</span>
                  {# chap_count anotatsiya bo‘lsa o‘shani, bo‘lmasa chapters.count #}
                  <span class="text-purple-300">{{ manga.chap_count|default:manga.chapters.count }} Bob</span>
                </div>
              </div>
            </div>
          </a>
        </div>
        {% empty %}
        <div class="col-span-full text-center py-10">
          <div class="inline-block p-4 bg-gray-800 rounded-full mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <p class="text-gray-400">Hech narsa topilmadi. Filtrlarni o'zgartirib ko'ring.</p>
        </div>
        {% endfor %}
      </div>
    </section>

    {# Paginatsiya – GET’larni saqlagan holda. CACHE KALITI: sahifa + preserve_qs #}
    {% cache 3600 pagination page_obj.number preserve_qs %}
    {% if page_obj.has_other_pages %}
    <div class="py-6 mt-8">
      <div class="flex justify-center items-center gap-2">

        {% if page_obj.has_previous %}
          <a href="?{{ preserve_qs }}{% if preserve_qs %}&{% endif %}page={{ page_obj.previous_page_number }}"
             class="px-4 py-2 bg-gray-800 text-gray-300 rounded-lg hover:bg-purple-600 transition-colors duration-200 flex items-center"
             aria-label="Oldingi sahifa">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
          </a>
        {% endif %}

        {# elided_page_range ni view kontekstdan olamiz #}
        {% for num in elided_page_range %}
          {% if num == '…' %}
            <span class="px-3 py-2 text-gray-400">…</span>
          {% elif num == page_obj.number %}
            <span class="px-4 py-2 bg-purple-600 text-white rounded-lg shadow">{{ num }}</span>
          {% else %}
            <a href="?{{ preserve_qs }}{% if preserve_qs %}&{% endif %}page={{ num }}"
               class="px-4 py-2 bg-gray-800 text-gray-300 rounded-lg hover:bg-purple-600 transition-colors duration-200">
              {{ num }}
            </a>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <a href="?{{ preserve_qs }}{% if preserve_qs %}&{% endif %}page={{ page_obj.next_page_number }}"
             class="px-4 py-2 bg-gray-800 text-gray-300 rounded-lg hover:bg-purple-600 transition-colors duration-200 flex items-center"
             aria-label="Keyingi sahifa">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        {% endif %}

      </div>
    </div>
    {% endif %}
    {% endcache %}
  </main>
</div>

{# Filtr paneli JS (statik fayl) va sort select uchun kichik script #}
{% cache 86400 filter_toggle_js %}
<script src="{% static 'js/sidebar.js' %}"></script>
<script>
  // Sort select: mavjud GET’ni saqlab, sortni almashtiradi va page ni 1 ga qaytaradi
  (function(){
    const sel = document.getElementById('sortSelect');
    if(!sel) return;
    sel.addEventListener('change', function(){
      const url  = new URL(window.location.href);
      const params = url.searchParams;
      params.set('sort', this.value);
      params.delete('page'); // 1-sahifaga qaytish
      url.search = params.toString();
      window.location.href = url.toString();
    });
  })();
</script>
{% endcache %}
{% endblock %}
