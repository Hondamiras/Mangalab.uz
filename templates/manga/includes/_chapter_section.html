{# ---------- CHAPTERS SECTION ---------- #}
{% if chapters %}
<div class="glass-container">
  {# Заголовок и переключатель сортировки #}
  <div class="flex items-center justify-between mb-4">
    <h2
      class="text-lg sm:text-2xl font-bold
             bg-gradient-to-r from-purple-400 to-pink-400
             bg-clip-text text-transparent"
    >
      Boblar ro'yxati</span>
    </h2>
    
    <div class="flex items-center space-x-2">
      <a
        href="?order=asc"
        class="px-3 py-1 text-sm rounded-full border transition
               {% if current_order == 'asc' %}
                 bg-purple-500 text-white border-purple-600
               {% else %}
                 bg-gray-800 text-gray-400 border-gray-700 hover:bg-gray-700
               {% endif %}"
      >
        1 → 10
      </a>
      <a
        href="?order=desc"
        class="px-3 py-1 text-sm rounded-full border transition
               {% if current_order == 'desc' %}
                 bg-purple-500 text-white border-purple-600
               {% else %}
                 bg-gray-800 text-gray-400 border-gray-700 hover:bg-gray-700
               {% endif %}"
      >
        10 → 1
      </a>
    </div>
  </div>
 
  <ul class="divide-y divide-gray-700 rounded-lg overflow-hidden">
    <div class="px-4 py-3 bg-gray-800/50 border-b border-gray-700">
        <span class="ml-2 px-2 py-1 bg-gray-700 rounded-md text-xs text-gray-400">
        Boblar  {{ chapters|length }} ta
        </span>
    </div>
    
    {% for chapter in chapters %}
      <li class="group">
        {% if chapter.can_read %}
          <a
            href="{% url 'manga:chapter_read' manga.slug chapter.volume chapter.chapter_number %}"
            class="flex items-center justify-between px-4 py-3 hover:bg-indigo-900/20 transition-colors duration-200"
          >
            <div class="flex items-center space-x-3">
              <div>
                <p class="text-gray-100 font-medium">
                  Jild {{ chapter.volume }} • Bob {{ chapter.chapter_number }}
                </p>
              </div>
            </div>
            <div class="flex items-center space-x-4">
              <span class="text-xs text-gray-400 hidden sm:block">
                {{ chapter.release_date|date:"d.m.Y" }}
              </span>
              <i class="fas fa-chevron-right text-xs text-gray-500 group-hover:text-indigo-400 transition-colors"></i>
            </div>
          </a>
          {% else %}
            <div
              class="flex items-center justify-between px-4 py-3 group hover:bg-indigo-900/20 transition-colors duration-200"
            > 
              <div class="flex items-center space-x-3">
                <div>
                  <p class="text-gray-500 font-medium">
                    Jild {{ chapter.volume }} • Bob {{ chapter.chapter_number }}
                  </p>
                </div>
              </div>
              <div class="flex items-center space-x-4">
                <button 
                  class="purchase-btn flex items-center gap-2 px-3 py-1.5 text-sm rounded-md bg-purple-600 hover:bg-purple-700 text-white transition-colors"
                  data-url="{% url 'manga:purchase_chapter' manga.slug chapter.volume chapter.chapter_number %}"
                  data-chapter-url="{% url 'manga:chapter_read' manga.slug chapter.volume chapter.chapter_number %}"
                  data-title="{{ manga.title }}"
                  data-chapter="{{ chapter.chapter_number }}"
                  data-price="{{ chapter.price_tanga }}"
                  data-date="{{ chapter.release_date|date:'d.m.Y' }}">
                  <i class="fas fa-shopping-cart"></i> 
                  <span>Sotib olish</span>
                  <span class="flex items-center ml-1 text-yellow-300">
                    <i class="fas fa-coins mr-1"></i>
                    {{ chapter.price_tanga }}
                  </span>
                </button>
              </div>
            </div>
          {% endif %}
      </li>
    {% endfor %}
  </ul>
</div>

<!-- Purchase Modal -->
<div id="buyModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-8 text-center max-w-md w-full 
                border border-purple-500/30 shadow-2xl shadow-purple-500/10">
        <div class="mb-6 flex justify-center">
            <div class="bg-yellow-500/20 p-4 rounded-full border border-yellow-500/40">
                <i class="fas fa-crown text-3xl text-yellow-400"></i>
            </div>
        </div>
        <h2 class="text-2xl font-bold text-yellow-400 mb-3">Premium Bob</h2>
        <p class="text-gray-300 mb-6 leading-relaxed" id="modalChapterInfo">
            <!-- Dynamic content will be inserted here -->
        </p>
        <div class="bg-gray-700/50 rounded-lg p-4 mb-6 border border-gray-600/50">
            <p class="text-gray-200 text-lg">
                Narx: <span class="text-purple-400 font-bold" id="modalChapterPrice">0</span> tanga
            </p>
        </div>
        <div class="flex justify-center space-x-4">
            <button id="confirmBuyBtn"
                    class="px-6 py-3 rounded-xl bg-purple-600 hover:bg-purple-700 transition-all
                           flex items-center space-x-2">
                <i class="fas fa-shopping-cart"></i>
                <span>Sotib olish</span>
            </button>
            <button id="closeBuyModal"
                    class="px-6 py-3 rounded-xl bg-gray-600
                           hover:bg-gray-700 transition-all
                            text-white
                           flex items-center space-x-2">
                <i class="fas fa-times"></i>
                <span>Bekor qilish</span>
            </button>
        </div>
    </div>
</div>

<script>
  // Modal elements
  const buyModal = document.getElementById('buyModal');
  const closeBuyModal = document.getElementById('closeBuyModal');
  const confirmBuyBtn = document.getElementById('confirmBuyBtn');
  const modalChapterInfo = document.getElementById('modalChapterInfo');
  const modalChapterPrice = document.getElementById('modalChapterPrice');

  // Variables to store current purchase data
  let currentPurchaseUrl = '';
  let currentChapterUrl = '';
  let currentButtonElement = null;

  // Show modal when purchase button is clicked
  document.querySelectorAll('.purchase-btn').forEach(button => {
    button.addEventListener('click', function() {
      const title = button.dataset.title;
      const chapter = button.dataset.chapter;
      const price = button.dataset.price;
      const date = button.dataset.date;
      
      currentPurchaseUrl = button.dataset.url;
      currentChapterUrl = button.dataset.chapterUrl;
      currentButtonElement = button;
      
      // Update modal content
      modalChapterInfo.innerHTML = `
        "<span class="text-white font-medium">${title}</span>" mangasining 
        <span class="text-yellow-300">${chapter}-bobi</span> 
        pullik kontent hisoblanadi.
      `;
      modalChapterPrice.textContent = price;
      
      // Show modal
      buyModal.classList.remove('hidden');
    });
  });

  // Close modal
  closeBuyModal.addEventListener('click', function() {
    buyModal.classList.add('hidden');
  });

  // Confirm purchase
  confirmBuyBtn.addEventListener('click', function() {
    // Disable button during request
    confirmBuyBtn.disabled = true;
    confirmBuyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Iltimos kuting...</span>';

    fetch(currentPurchaseUrl, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'X-Requested-With': 'XMLHttpRequest',
      },
    })
    .then(res => res.json())
    .then(data => {
      showToast(data.message, data.success);
      if (data.success) {
        // Close modal
        buyModal.classList.add('hidden');
        
        // Update the button's parent to show unlocked chapter
        if (currentButtonElement) {
          const parentDiv = currentButtonElement.closest('.flex.items-center.justify-between');
          parentDiv.innerHTML = `
            <a href="${currentChapterUrl}" 
              class="flex items-center justify-between w-full">
              <div class="flex items-center space-x-3">
                <p class="text-gray-100 font-medium">
                  ${parentDiv.querySelector('p').innerText}
                </p>
              </div>
              <div class="flex items-center space-x-4">
                <span class="text-xs text-gray-400 hidden sm:block">${currentButtonElement.dataset.date}</span>
                <i class="fas fa-chevron-right text-xs text-gray-500 group-hover:text-indigo-400 transition-colors"></i>
              </div>
            </a>`;
        }
      }
    })
    .catch(() => {
      showToast("Xatolik yuz berdi, qayta urinib ko'ring!", false);
    })
    .finally(() => {
      confirmBuyBtn.disabled = false;
      confirmBuyBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> <span>Sotib olish</span>';
    });
  });

  // Toast notification function
  function showToast(message, success) {
    const toast = document.createElement('div');
    toast.className = `fixed top-5 right-5 px-4 py-2 rounded shadow-lg text-white z-50 transition transform duration-300
                      ${success ? 'bg-green-600' : 'bg-red-600'}`;
    toast.innerHTML = `<i class="fas ${success ? 'fa-check-circle' : 'fa-times-circle'} mr-2"></i>${message}`;
    document.body.appendChild(toast);
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-20px)';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }
</script>

{% endif %}
