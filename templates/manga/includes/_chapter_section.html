{# ---------- CHAPTERS SECTION (status-aware) ---------- #}
{% if chapters %}
<div class="glass-container">

  {# Header + sort #}
  <div class="flex items-center justify-between mb-3">
    <h2 class="text-lg sm:text-2xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
      Boblar ro'yxati
    </h2>
    <div class="flex items-center gap-1">
      <a href="?order=asc"
         class="px-3 py-1 text-xs sm:text-sm rounded-full border transition
                {% if current_order == 'asc' %} bg-purple-500 text-white border-purple-600
                {% else %} bg-gray-800 text-gray-400 border-gray-700 hover:bg-gray-700 {% endif %}">
        1 → 10
      </a>
      <a href="?order=desc"
         class="px-3 py-1 text-xs sm:text-sm rounded-full border transition
                {% if current_order == 'desc' %} bg-purple-500 text-white border-purple-600
                {% else %} bg-gray-800 text-gray-400 border-gray-700 hover:bg-gray-700 {% endif %}">
        10 → 1
      </a>
    </div>
  </div>

  {# Legend (compact) #}
  <div class="flex flex-wrap items-center gap-2 mb-2 text-xs text-gray-400">
    <span class="inline-flex items-center gap-1"><span class="h-2 w-2 rounded-full bg-green-500"></span> Kelgan</span>
    <span class="inline-flex items-center gap-1"><span class="h-2 w-2 rounded-full bg-sky-500"></span> O‘qilgan</span>
    <span class="inline-flex items-center gap-1"><span class="h-2 w-2 rounded-full bg-gray-500"></span> O‘qilmagan</span>
    <span class="inline-flex items-center gap-1"><i class="fas fa-lock text-yellow-400"></i> Qulflangan</span>
    <span class="ml-auto px-2 py-0.5 rounded-md bg-gray-800/60 border border-gray-700">Jami: {{ chapters|length }}</span>
  </div>

  <ul class="divide-y divide-gray-700 rounded-lg overflow-hidden">

    {% for chapter in chapters %}
      {% with is_current=chapter.is_current %}
      <li class="group">
        {% if chapter.can_read %}
          {# ACCESS: openable #}
          <a href="{% url 'manga:chapter_read' manga.slug chapter.volume chapter.chapter_number %}"
             class="flex items-center justify-between px-4 py-2.5 transition-colors
                    {% if is_current %} bg-green-900/10 hover:bg-green-900/20 border-l-4 border-l-green-500
                    {% else %} hover:bg-indigo-900/20 {% endif %}">

            <div class="flex items-center gap-3">
              {# status dot #}
              {% if is_current %}
                <span class="h-2.5 w-2.5 rounded-full bg-green-500"></span>
              {% elif visited_chapter_ids and chapter.id in visited_chapter_ids %}
                <span class="h-2.5 w-2.5 rounded-full bg-sky-500"></span>
              {% else %}
                <span class="h-2.5 w-2.5 rounded-full bg-gray-500"></span>
              {% endif %}

              <p class="text-gray-100 font-medium">
                Jild {{ chapter.volume }} • Bob {{ chapter.chapter_number }}
                {% if is_current %}
                  {% comment %} <span class="ml-2 px-1.5 py-0.5 text-[10px] rounded bg-green-600/20 text-green-300 border border-green-600/30">
                    Kelgan{% if chapter.current_page %}{% endif %}
                  </span> {% endcomment %}
                {% elif visited_chapter_ids and chapter.id in visited_chapter_ids %}
                  {% comment %} <span class="ml-2 px-1.5 py-0.5 text-[10px] rounded bg-sky-600/20 text-sky-300 border border-sky-600/30">
                    O‘qilgan
                  </span> {% endcomment %}
                {% else %}
                  {% comment %} <span class="ml-2 px-1.5 py-0.5 text-[10px] rounded bg-gray-600/20 text-gray-300 border border-gray-600/30">
                    O‘qilmagan
                  </span> {% endcomment %}
                {% endif %}
              </p>
            </div>

            <div class="flex items-center gap-4">
              <span class="text-[11px] text-gray-400 hidden sm:block">
                {{ chapter.release_date|date:"d.m.Y" }}
              </span>
              <i class="fas fa-chevron-right text-xs text-gray-500 group-hover:text-indigo-400 transition-colors"></i>
            </div>
          </a>

        {% else %}
          {# LOCKED: need purchase #}
          <div class="flex items-center justify-between px-4 py-2.5 group hover:bg-indigo-900/10 transition-colors">

            <div class="flex items-center gap-3">
              <i class="fas fa-lock text-yellow-400 text-xs"></i>
              <p class="text-gray-500 font-medium">
                Jild {{ chapter.volume }} • Bob {{ chapter.chapter_number }}
                {% comment %} <span class="ml-2 px-1.5 py-0.5 text-[10px] rounded bg-amber-600/20 text-amber-300 border border-amber-600/30">
                  Qulflangan
                </span> {% endcomment %}
              </p>
            </div>

            <div class="flex items-center gap-3">
              <span class="hidden sm:inline text-[11px] text-gray-400">{{ chapter.release_date|date:"d.m.Y" }}</span>
              <button 
                class="purchase-btn flex items-center gap-2 px-2.5 py-1.5 text-xs rounded-md bg-purple-600 hover:bg-purple-700 text-white transition-colors"
                data-url="{% url 'manga:purchase_chapter' manga.slug chapter.volume chapter.chapter_number %}"
                data-chapter-url="{% url 'manga:chapter_read' manga.slug chapter.volume chapter.chapter_number %}"
                data-title="{{ manga.title }}"
                data-chapter="{{ chapter.chapter_number }}"
                data-price="{{ chapter.price_tanga }}"
                data-date="{{ chapter.release_date|date:'d.m.Y' }}">
                <i class="fas fa-shopping-cart"></i>
                <span>{{ chapter.price_tanga }}</span>
                <i class="fas fa-coins opacity-80"></i>
              </button>
            </div>
          </div>
        {% endif %}
      </li>
      {% endwith %}
    {% endfor %}

  </ul>
</div>

{# ---------- Purchase Modal ---------- #}
<div id="buyModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
  <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-8 text-center max-w-md w-full border border-purple-500/30 shadow-2xl shadow-purple-500/10">
    <div class="mb-6 flex justify-center">
      <div class="bg-yellow-500/20 p-4 rounded-full border border-yellow-500/40">
        <i class="fas fa-crown text-3xl text-yellow-400"></i>
      </div>
    </div>
    <h2 class="text-2xl font-bold text-yellow-400 mb-3">Premium Bob</h2>
    <p class="text-gray-300 mb-6 leading-relaxed" id="modalChapterInfo"></p>
    <div class="bg-gray-700/50 rounded-lg p-4 mb-6 border border-gray-600/50">
      <p class="text-gray-200 text-lg">
        Narx: <span class="text-purple-400 font-bold" id="modalChapterPrice">0</span> tanga
      </p>
    </div>
    <div class="flex justify-center gap-3">
      <button id="confirmBuyBtn"
              class="px-5 py-2.5 rounded-xl bg-purple-600 hover:bg-purple-700 transition-all flex items-center gap-2">
        <i class="fas fa-shopping-cart"></i><span>Sotib olish</span>
      </button>
      <button id="closeBuyModal"
              class="px-5 py-2.5 rounded-xl bg-gray-600 hover:bg-gray-700 transition-all text-white flex items-center gap-2">
        <i class="fas fa-times"></i><span>Bekor qilish</span>
      </button>
    </div>
  </div>
</div>

<script>
  // Modal elements
  const buyModal = document.getElementById('buyModal');
  const closeBuyModal = document.getElementById('closeBuyModal');
  const confirmBuyBtn = document.getElementById('confirmBuyBtn');
  const modalChapterInfo = document.getElementById('modalChapterInfo');
  const modalChapterPrice = document.getElementById('modalChapterPrice');

  let currentPurchaseUrl = '';
  let currentChapterUrl = '';
  let currentButtonElement = null;

  // Show modal
  document.querySelectorAll('.purchase-btn').forEach(button => {
    button.addEventListener('click', function() {
      const title = button.dataset.title;
      const chapter = button.dataset.chapter;
      const price = button.dataset.price;

      currentPurchaseUrl = button.dataset.url;
      currentChapterUrl = button.dataset.chapterUrl;
      currentButtonElement = button;

      modalChapterInfo.innerHTML =
        '<span class="text-white font-medium">' + title + '</span> mangasining ' +
        '<span class="text-yellow-300">' + chapter + '-bobi</span> pullik kontent hisoblanadi.';
      modalChapterPrice.textContent = price;

      buyModal.classList.remove('hidden');
    });
  });

  // Close modal
  closeBuyModal.addEventListener('click', function() {
    buyModal.classList.add('hidden');
  });

  // Confirm purchase
  confirmBuyBtn.addEventListener('click', function() {
    confirmBuyBtn.disabled = true;
    confirmBuyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Iltimos kuting...</span>';

    fetch(currentPurchaseUrl, {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}', 'X-Requested-With': 'XMLHttpRequest' },
    })
    .then(res => res.json())
    .then(data => {
      showToast(data.message || (data.success ? 'Xarid muvaffaqiyatli' : 'Xarid amalga oshmadi'), data.success);
      if (data.success) {
        buyModal.classList.add('hidden');

        // Convert locked row to open link
        if (currentButtonElement) {
          const parentDiv = currentButtonElement.closest('.flex.items-center.justify-between');
          const titleP = parentDiv.querySelector('p') ? parentDiv.querySelector('p').innerText : '';
          parentDiv.innerHTML =
            '<a href="' + currentChapterUrl + '" class="flex items-center justify-between w-full px-0">' +
              '<div class="flex items-center gap-3">' +
                '<span class="h-2.5 w-2.5 rounded-full bg-gray-500"></span>' +
                '<p class="text-gray-100 font-medium">' + titleP + '</p>' +
              '</div>' +
              '<div class="flex items-center gap-4">' +
                '<i class="fas fa-chevron-right text-xs text-gray-500 group-hover:text-indigo-400 transition-colors"></i>' +
              '</div>' +
            '</a>';
        }
      }
    })
    .catch(() => { showToast("Xatolik yuz berdi, qayta urinib ko'ring!", false); })
    .finally(() => {
      confirmBuyBtn.disabled = false;
      confirmBuyBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> <span>Sotib olish</span>';
    });
  });

  // Toast
  function showToast(message, success) {
    const toast = document.createElement('div');
    toast.className =
      'fixed top-5 right-5 px-4 py-2 rounded shadow-lg text-white z-50 transition transform duration-300 ' +
      (success ? 'bg-green-600' : 'bg-red-600');
    toast.innerHTML = '<i class="fas ' + (success ? 'fa-check-circle' : 'fa-times-circle') + ' mr-2"></i>' + message;
    document.body.appendChild(toast);
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-20px)';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }
</script>
{% endif %}
