{% if chapter.preview or chapter.pdf %}
  <div class="pdf-viewer-container relative">
    <!-- Контейнер для страниц: по умолчанию вертикально, на desktop — горизонтальная прокрутка -->
    <div
      id="pdf-pages"
      class="flex flex-col lg:flex-row lg:overflow-x-auto lg:space-x-4 scrollbar-thin scrollbar-thumb-gray-500 scrollbar-track-gray-200"
    >
      {# 1) Моментальное превью #}
      {% if chapter.preview %}
        <img
          id="pdf-preview"
          src="{{ chapter.preview.url }}"
          alt="Preview страницы {{ chapter.chapter_number }}"
          class="pdf-page flex-shrink-0 w-full lg:w-auto"
        >
      {% endif %}
    </div>

    <!-- Спиннер поверх всего -->
    <div id="pdf-loading" class="absolute inset-0 flex items-center justify-center z-10">
      <div class="spinner"></div>
    </div>
  </div>

  <style>
    .pdf-viewer-container {
      position: relative;
      width: 100%;
      margin: 0 auto;
      padding: 0;
      background: #fff;
      min-height: calc(100vh - var(--navbar-height, 56px));
    }

    .spinner {
      width: 3rem;
      height: 3rem;
      border: 4px solid #e5e7eb;
      border-top-color: #6366f1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .pdf-page {
      display: block;
      height: auto;
    }
    /* На desktop: все страницы в одной строке, высота под размер экрана */
    @media (min-width: 1024px) {
      .pdf-page {
        flex: 0 0 auto;
        max-height: calc(100vh - var(--navbar-height, 56px));
        width: auto;
      }
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const url          = "{{ chapter.pdf.url }}";
      const preview      = document.getElementById('pdf-preview');
      const pagesWrapper = document.getElementById('pdf-pages');
      const loader       = document.getElementById('pdf-loading');
      const navbar       = document.getElementById('navbar');
      const container    = document.querySelector('.pdf-viewer-container');

      // Учитываем высоту navbar
      const navH = navbar?.offsetHeight || 0;
      container.style.minHeight = (window.innerHeight - navH) + 'px';

      async function renderFirstPage() {
        const loadingTask = pdfjsLib.getDocument({ url, disableRange: false });
        const pdf = await loadingTask.promise;
        const page = await pdf.getPage(1);

        // Вычисляем масштаб по высоте экрана (desktop) или по ширине (mobile)
        let scale;
        const vp1 = page.getViewport({ scale: 1 });
        if (window.innerWidth >= 1024) {
          // desktop: высота под экран
          const maxH = window.innerHeight - navH;
          scale = Math.min(maxH / vp1.height, 1);
        } else {
          // mobile/tablet: ширина под контейнер
          const cw = pagesWrapper.clientWidth;
          scale = Math.min(cw / vp1.width, 1);
        }
        const dpr = Math.min(window.devicePixelRatio || 1, 2);
        const viewport = page.getViewport({ scale: scale * dpr });

        // Рендерим первую страницу
        const canvas = document.createElement('canvas');
        canvas.className = 'pdf-page';
        canvas.width     = viewport.width;
        canvas.height    = viewport.height;
        const ctx        = canvas.getContext('2d');
        await page.render({ canvasContext: ctx, viewport }).promise;
        pagesWrapper.appendChild(canvas);

        // Убираем превью и спиннер
        if (preview) preview.remove();
        loader.style.display = 'none';

        // Подгружаем остальные страницы лениво
        lazyLoadRemaining(pdf, scale * dpr);
      }

      function lazyLoadRemaining(pdf, fullScale) {
        const observer = new IntersectionObserver(async entries => {
          for (const e of entries) {
            if (e.isIntersecting) {
              const num = +e.target.dataset.page;
              const page = await pdf.getPage(num);
              const vp = page.getViewport({ scale: fullScale });
              const canvas = document.createElement('canvas');
              canvas.className = 'pdf-page';
              canvas.width  = vp.width;
              canvas.height = vp.height;
              const ctx = canvas.getContext('2d');
              await page.render({ canvasContext: ctx, viewport: vp }).promise;
              e.target.replaceWith(canvas);
              observer.unobserve(e.target);
            }
          }
        }, { rootMargin: '200px' });

        // Добавляем плейсхолдеры для всех последующих страниц
        pdf.getPage(1).then(first => {
          const vp1 = first.getViewport({ scale: 1 });
          for (let i = 2; i <= pdf.numPages; i++) {
            const ph = document.createElement('div');
            ph.dataset.page = i;
            ph.className    = 'pdf-page';
            // задаём высоту как для первой, ширину auto
            ph.style.height = `${vp1.height * fullScale}px`;
            pagesWrapper.appendChild(ph);
            observer.observe(ph);
          }
        });
      }

      renderFirstPage().catch(err => {
        console.error("PDF.js error:", err);
        loader.innerText = "Не удалось загрузить PDF. Обновите страницу.";
      });
    });
  </script>
{% endif %}
