{% if chapter.pdf %}
  <div class="pdf-viewer-container">
    <!-- Loader -->
    <div id="pdf-loading" class="pdf-loading-overlay">
      <div class="spinner"></div>
    </div>
    <!-- Pages container -->
    <div id="pdf-pages" class="flex flex-col items-center"></div>
  </div>

  <style>
    .pdf-viewer-container {
      position: relative;
      max-width: 100%;
      margin: 0 auto;
      padding: 0;
      min-height: calc(100vh - var(--navbar-height, 56px));
    }
    .pdf-loading-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: transparent;
      z-index: 10;
    }
    .spinner {
      width: 3rem;
      height: 3rem;
      border: 4px solid #e5e7eb;
      border-top-color: #6366f1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .pdf-page {
      display: block;
      background: white;
      margin: 0 !important;
      max-width: 100% !important;
      height: auto !important;
      transform-origin: top center;
      transition: transform 0.2s ease;
    }
    #pdf-pages { gap: 0; }
  </style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const url = "{{ chapter.pdf.url }}";  // URL вашего PDF-файла
    const loadingOverlay = document.getElementById('pdf-loading');
    const pagesWrapper   = document.getElementById('pdf-pages');
    const navbar         = document.getElementById('navbar');
    const container      = document.querySelector('.pdf-viewer-container');

    // Устанавливаем минимальную высоту контейнера под навбар
    const navH = navbar?.offsetHeight || 0;
    container.style.minHeight = (window.innerHeight - navH) + 'px';

    // Функция рендера одной страницы
    async function renderPage(page, scale) {
      const viewport = page.getViewport({ scale });
      const canvas = document.createElement('canvas');
      canvas.className = 'pdf-page';
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      const ctx = canvas.getContext('2d');
      ctx.imageSmoothingEnabled = false;
      await page.render({ canvasContext: ctx, viewport }).promise;
      pagesWrapper.appendChild(canvas);
    }

    (async () => {
      try {
        // Задаём, чтобы PDF.js использовал HTTP Range-запросы
        const loadingTask = pdfjsLib.getDocument({
          url,
          disableStream: false,
          disableRange: false
        });
        const pdf = await loadingTask.promise;

        // Вычисляем масштаб: не больше 1× при DPR ≤ 2
        const cw  = pagesWrapper.clientWidth;
        const first = await pdf.getPage(1);
        const vp1 = first.getViewport({ scale: 1 });
        const baseScale = Math.min(cw / vp1.width, 1);
        const dpr       = Math.min(window.devicePixelRatio || 1, 2);
        const renderScale = baseScale * dpr;

        // Отрисовываем сразу первые 3 страницы
        const initialCount = Math.min(3, pdf.numPages);
        for (let i = 1; i <= initialCount; i++) {
          const page = await pdf.getPage(i);
          await renderPage(page, renderScale);
        }

        // Ленивый рендеринг остальных страниц
        const observer = new IntersectionObserver(async entries => {
          for (const entry of entries) {
            if (entry.isIntersecting) {
              const pageNum = +entry.target.dataset.page;
              const page = await pdf.getPage(pageNum);
              await renderPage(page, renderScale);
              observer.unobserve(entry.target);
              entry.target.remove();
            }
          }
        }, { rootMargin: '200px' });

        // Создаём плейсхолдеры для страниц 4…N
        const placeholderHeight = vp1.height * baseScale + 'px';
        for (let i = initialCount + 1; i <= pdf.numPages; i++) {
          const ph = document.createElement('div');
          ph.dataset.page = i;
          ph.style.width  = '100%';
          ph.style.height = placeholderHeight;
          ph.className    = 'pdf-page';
          pagesWrapper.appendChild(ph);
          observer.observe(ph);
        }

      } catch (err) {
        console.error("PDF loading error:", err);
        loadingOverlay.innerText = "Xatolik yuz berdi. Sahifani yangilang.";
      } finally {
        // Скрываем спиннер
        loadingOverlay.style.opacity = '0';
        setTimeout(() => loadingOverlay.remove(), 300);
      }
    })();
  });
</script>
{% endif %}
