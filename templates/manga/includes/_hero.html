{% load cache %}
{% load humanize %}
{% load numfmt %}

<style>
  [x-cloak]{ display:none !important; }
  .no-scrollbar{
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .no-scrollbar::-webkit-scrollbar{
    width: 0;
    height: 0;
    display: none;
  }
</style>

<section class="relative mb-10">
  <div class="px-2 sm:px-0 py-2 sm:py-3 md:py-4">
    <div class="flex flex-col lg:flex-row gap-8 lg:gap-10">

      {# ---------------- LEFT: COVER ---------------- #}
      <div class="flex-shrink-0 self-center lg:self-start">
        {% cache 86400 hero_cover manga.slug manga.cover_image.url manga.age_rating manga.publication_date reads_all %}
        <div class="relative overflow-hidden rounded-[26px] border border-white/10 shadow-2xl">
          <img
            src="{{ manga.cover_image.url }}"
            alt="{{ manga.title }}"
            class="w-[270px] sm:w-[300px] md:w-[320px] lg:w-[300px] aspect-[3/4] object-cover"
          />

          <div class="absolute left-4 top-4 flex items-center gap-3 z-10">
            {% if manga.age_rating %}
              <span class="inline-flex items-center gap-2 px-4 py-2 rounded-2xl bg-red-600/95 text-white text-sm font-semibold shadow-lg">
                {{ manga.age_rating }}
              </span>
            {% endif %}

            {% if manga.publication_date %}
              <span class="inline-flex items-center gap-2 px-4 py-2 rounded-2xl bg-purple-600/90 text-white text-sm font-semibold shadow-lg">
                <i class="fa-solid fa-calendar-days text-[13px] opacity-95"></i>
                {{ manga.publication_date|date:"Y" }}
              </span>
            {% endif %}
          </div>

          <div class="absolute right-4 bottom-4 z-10">
            <span class="inline-flex items-center gap-3 px-5 py-2 rounded-2xl bg-black/60 border border-white/10 text-gray-100 text-sm font-semibold shadow-lg">
              <i class="fa-solid fa-eye opacity-90"></i>
              {{ reads_all|default:0|intcomma }}
            </span>
          </div>

          <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-black/35 via-transparent to-transparent"></div>
        </div>
        {% endcache %}
      </div>

      {# ---------------- RIGHT: INFO ---------------- #}
      <div class="flex-1 min-w-0 flex flex-col justify-start">

        {% cache 86400 hero_title manga.slug manga.title manga.author %}
        <div class="space-y-3 text-center sm:text-left">
          <h1 class="text-4xl sm:text-5xl md:text-6xl font-extrabold tracking-tight text-purple-400 break-words">
            {{ manga.title }}
          </h1>
          <div class="text-xl sm:text-2xl text-gray-200/90 font-medium">
            {{ manga.author }}
          </div>
        </div>
        {% endcache %}

        {% if translator_profiles %}
          <div class="mt-7 flex flex-wrap items-center gap-3">
            <span class="text-purple-300 font-semibold">
              Tarjimon{% if translator_profiles|length > 1 %}lar{% endif %}:
            </span>

            <div class="flex flex-wrap items-center gap-3">
              {% for t in translator_profiles %}
                <a href="{% url 'accounts:translator_profile' t.user.username %}"
                   class="inline-flex items-center px-6 py-2 rounded-2xl bg-slate-900/35 border border-white/10 text-gray-100 font-semibold hover:bg-slate-900/55 transition">
                  {{ t.user.username }}
                </a>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% cache 86400 hero_status_pills manga.slug manga.status manga.translation_status %}
        <div class="mt-7 flex flex-wrap items-center gap-4">
          <a href="{% url 'manga:browse' %}?status={{ manga.status|urlencode }}"
             class="inline-flex items-center gap-3 px-6 py-3 rounded-2xl bg-purple-600/10 border border-purple-500/25 text-purple-200 font-semibold hover:bg-purple-600/15 transition">
            <i class="fa-solid fa-shield opacity-90"></i>
            <span>{{ manga.get_type_display }}: {{ manga.get_status_display }}</span>
          </a>

          <a href="{% url 'manga:browse' %}?translation={{ manga.translation_status|urlencode }}"
             class="inline-flex items-center gap-3 px-6 py-3 rounded-2xl bg-blue-600/10 border border-blue-500/25 text-blue-200 font-semibold hover:bg-blue-600/15 transition">
            <i class="fa-solid fa-rotate opacity-90"></i>
            <span>{{ manga.get_translation_status_display }}</span>
          </a>
        </div>
        {% endcache %}

        {% if manga.genres.exists %}
          <div class="mt-6">
            <div class="flex flex-nowrap gap-3 overflow-x-auto no-scrollbar -mx-2 px-2 pb-2">
              {% for genre in manga.genres.all %}
                <a href="{% url 'manga:browse' %}?genre={{ genre.name|urlencode }}"
                   class="flex-none inline-flex items-center gap-3 whitespace-nowrap px-6 py-3 rounded-2xl
                          bg-purple-600/10 border border-purple-500/25 text-purple-200 font-semibold
                          hover:bg-purple-600/15 transition">
                  <i class="fa-solid fa-tag opacity-80"></i>
                  {{ genre.name }}
                </a>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if manga.tags.exists %}
          <div class="mt-4">
            <div class="flex flex-nowrap gap-3 overflow-x-auto no-scrollbar -mx-2 px-2 pb-2">
              {% for tag in manga.tags.all %}
                <a href="{% url 'manga:browse' %}?tag={{ tag.name|urlencode }}"
                   class="flex-none inline-flex items-center gap-3 whitespace-nowrap px-6 py-3 rounded-2xl
                          bg-emerald-700/20 border border-emerald-400/25 text-emerald-200 font-semibold
                          hover:bg-emerald-700/25 transition shadow-inner">
                  <i class="fa-solid fa-hashtag opacity-80"></i>
                  {{ tag.name }}
                </a>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {# ---------------- ACTION ROW ---------------- #}
        <div class="mt-7 grid grid-cols-2 lg:grid-cols-4 gap-4">

          {# 1) Reading status #}
          <div class="col-span-2 lg:col-span-1">
            {% if request.user.is_authenticated %}
              <form method="post" action="{% url 'manga:add_to_reading_list' manga.slug %}">
                {% csrf_token %}
                <div class="relative">
                  <select name="status" onchange="this.form.submit()"
                          class="h-14 w-full pl-5 pr-12 rounded-2xl
                                 bg-slate-900/30 border border-white/10 text-purple-200 font-semibold
                                 focus:outline-none focus:ring-2 focus:ring-purple-400/40 appearance-none">
                    <option value="remove">O'qish holati</option>
                    {% for val,label in READING_STATUSES %}
                      <option value="{{ val }}" {% if reading_status and reading_status.status == val %}selected{% endif %}>
                        {{ label }}
                      </option>
                    {% endfor %}
                  </select>

                  <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-5 text-gray-300/80">
                    <i class="fa-solid fa-chevron-down"></i>
                  </div>
                </div>
              </form>
            {% else %}
              <button type="button"
                      data-require-login
                      data-login-text="Ro'yxatga qo'shish uchun kiring."
                      class="h-14 w-full inline-flex items-center justify-center rounded-2xl
                             bg-slate-900/30 border border-white/10 text-purple-200 font-semibold
                             hover:bg-slate-900/45 transition">
                O'qish holati
              </button>
            {% endif %}
          </div>

          {# 2) Continue / Start #}
          <div class="col-span-2 lg:col-span-1">
            {% if first_chapter %}
              {% if progress_current_chapter_id %}
                {% for c in chapters %}
                  {% if c.id == progress_current_chapter_id %}
                    <a href="{% url 'manga:chapter_read' manga.slug c.volume c.chapter_number %}"
                       class="h-14 w-full inline-flex items-center justify-center gap-3 rounded-2xl
                              bg-purple-600 text-white font-bold shadow-lg
                              hover:bg-purple-700 transition focus:outline-none focus:ring-2 focus:ring-purple-400/50">
                      <i class="fa-solid fa-rotate"></i>
                      <span class="font-bold">Davom ettirish (Bob {{ c.chapter_number }})</span>
                    </a>
                  {% endif %}
                {% endfor %}
              {% else %}
                <a href="{% url 'manga:chapter_read' manga.slug first_chapter.volume first_chapter.chapter_number %}"
                   class="h-14 w-full inline-flex items-center justify-center gap-3 rounded-2xl
                          bg-purple-600 text-white font-bold shadow-lg
                          hover:bg-purple-700 transition focus:outline-none focus:ring-2 focus:ring-purple-400/50">
                  <i class="fa-solid fa-play"></i>
                  <span class="font-bold">O‘qishni boshlash</span>
                </a>
              {% endif %}
            {% else %}
              <div class="h-14 w-full inline-flex items-center justify-center rounded-2xl bg-slate-900/30 border border-white/10 text-gray-300">
                Bob yo‘q
              </div>
            {% endif %}
          </div>

          {# 3) Like #}
          <div class="col-span-1 lg:col-span-1">
            {% if request.user.is_authenticated %}
              <button id="likeBtn"
                      type="button"
                      data-url="{% url 'manga:manga_like_toggle' slug=manga.slug %}"
                      data-liked="{% if is_liked %}1{% else %}0{% endif %}"
                      class="h-14 w-full inline-flex items-center justify-center gap-3 rounded-2xl
                             border border-white/10 bg-slate-900/30 text-gray-200 font-bold
                             hover:bg-slate-900/45 transition
                             focus:outline-none focus:ring-2 focus:ring-white/20">
                <i id="likeIcon"
                   class="{% if is_liked %}fa-solid text-pink-400{% else %}fa-regular{% endif %} fa-heart text-lg"></i>
                <span id="likeCount">{{ likes_count|default:0|intcomma }}</span>
              </button>
            {% else %}
              <button type="button"
                      data-require-login
                      data-login-text="Like bosish uchun kiring."
                      class="h-14 w-full inline-flex items-center justify-center gap-3 rounded-2xl
                             bg-slate-900/30 border border-white/10 text-gray-200 font-bold
                             hover:bg-slate-900/45 transition">
                <i class="fa-regular fa-heart text-lg"></i>
                {{ likes_count|default:0|intcomma }}
              </button>
            {% endif %}
          </div>

          {# 4) Telegram #}
          <div class="col-span-1 lg:col-span-1">
            {% if telegram_links %}
              {% if telegram_links|length == 1 %}
                <a href="{{ telegram_links.0.link }}" target="_blank"
                   class="h-14 w-full inline-flex items-center justify-center gap-3 rounded-2xl
                          bg-blue-600 text-white font-bold shadow-lg hover:bg-blue-700 transition
                          focus:outline-none focus:ring-2 focus:ring-blue-300/50">
                  <i class="fa-brands fa-telegram text-xl"></i>
                  Telegram
                </a>
              {% else %}
                <button type="button"
                        onclick="document.getElementById('telegramModal').classList.remove('hidden')"
                        class="h-14 w-full inline-flex items-center justify-center gap-3 rounded-2xl
                               bg-blue-600 text-white font-bold shadow-lg hover:bg-blue-700 transition
                               focus:outline-none focus:ring-2 focus:ring-blue-300/50">
                  <i class="fa-brands fa-telegram text-xl"></i>
                  Telegram
                </button>
              {% endif %}
            {% else %}
              <div class="h-14 w-full inline-flex items-center justify-center rounded-2xl bg-slate-900/20 border border-white/5 text-gray-400">
                Telegram yo‘q
              </div>
            {% endif %}
          </div>

        </div>
      </div>
    </div>
  </div>

  {# ===== LOGIN TOAST (hammasiga umumiy) ===== #}
  <div id="ml-login-toast"
       class="fixed left-1/2 -translate-x-1/2 bottom-5 z-[9999] hidden w-[92vw] max-w-md
              rounded-2xl border border-white/10 bg-black/70 backdrop-blur px-4 py-3 shadow-2xl">
    <div class="flex items-center justify-between gap-3">
      <div class="text-sm text-white/95">
        <span id="ml-login-toast-text">Davom etish uchun kiring.</span>
      </div>
      <div class="flex items-center gap-2 shrink-0">
        <a id="ml-login-toast-link"
           href="{% url 'accounts:login' %}?next={{ request.get_full_path|urlencode }}"
           class="h-9 px-3 inline-flex items-center justify-center rounded-xl bg-purple-600 hover:bg-purple-500 text-white font-semibold">
          Kirish
        </a>
        <button type="button"
                class="h-9 px-3 inline-flex items-center justify-center rounded-xl bg-white/10 hover:bg-white/15 text-white"
                onclick="document.getElementById('ml-login-toast').classList.add('hidden')">
          Yopish
        </button>
      </div>
    </div>
  </div>

</section>

<script>
  // ===== login toast helper =====
  (function(){
    const toast = document.getElementById('ml-login-toast');
    const textEl = document.getElementById('ml-login-toast-text');
    const linkEl = document.getElementById('ml-login-toast-link');

    function showLoginToast(message){
      if (!toast) return;
      if (textEl) textEl.textContent = message || "Davom etish uchun kiring.";
      if (linkEl) linkEl.href = linkEl.href; // default next bilan turadi

      toast.classList.remove('hidden');

      clearTimeout(window.__mlToastT);
      window.__mlToastT = setTimeout(() => {
        toast.classList.add('hidden');
      }, 2300);
    }

    // glabal qilib qo'yamiz
    window.showLoginToast = showLoginToast;

    // data-require-login bo'lgan hamma button'lar
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-require-login]');
      if (!btn) return;
      const msg = btn.getAttribute('data-login-text') || "Davom etish uchun kiring.";
      showLoginToast(msg);
    });
  })();
</script>

<script>
  // ===== LIKE AJAX (faqat login bo'lsa likeBtn bor) =====
  (function(){
    const btn = document.getElementById('likeBtn');
    if (!btn) return;

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return '';
    }

    const icon = document.getElementById('likeIcon');
    const countEl = document.getElementById('likeCount');

    function setLikedUI(liked){
      btn.classList.toggle('bg-pink-600/15', liked);
      btn.classList.toggle('border-pink-500/40', liked);
      btn.classList.toggle('ring-2', liked);
      btn.classList.toggle('ring-pink-400/25', liked);

      if (icon){
        icon.classList.toggle('fa-solid', liked);
        icon.classList.toggle('fa-regular', !liked);
        icon.classList.toggle('text-pink-400', liked);
      }
    }

    setLikedUI(btn.dataset.liked === '1');

    btn.addEventListener('click', async () => {
      const url = btn.dataset.url;
      if (!url) return;

      btn.disabled = true;
      btn.classList.add('opacity-90');

      try {
        const resp = await fetch(url, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
          }
        });
        if (!resp.ok) throw new Error('Like failed');

        const data = await resp.json();

        if (countEl && typeof data.likes_count !== 'undefined') {
          const n = Number(String(data.likes_count).replaceAll(',', ''));
          countEl.textContent = isNaN(n) ? data.likes_count : n.toLocaleString('en-US');
        }

        const liked = !!data.liked;
        btn.dataset.liked = liked ? '1' : '0';
        setLikedUI(liked);

        btn.classList.add('scale-[1.02]');
        setTimeout(() => btn.classList.remove('scale-[1.02]'), 120);

      } catch (e) {
        // xohlasangiz showLoginToast("Xatolik...") yoki Toastify
      } finally {
        btn.classList.remove('opacity-90');
        btn.disabled = false;
      }
    });
  })();
</script>
