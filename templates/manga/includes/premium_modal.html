{# templates/manga/includes/premium_modal.html #}

<!-- ===== Premium Purchase Modal (global) ===== -->
<div id="buyModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 p-4">
  <div class="mx-auto w-full max-w-md sm:max-w-lg
              bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl
              p-6 sm:p-8 border border-purple-500/30 shadow-2xl shadow-purple-500/10
              relative top-1/2 -translate-y-1/2 text-center">
    <div class="mb-4 flex justify-center">
      <div class="bg-yellow-500/20 p-4 rounded-full border border-yellow-500/40">
        <i class="fas fa-crown text-3xl text-yellow-400"></i>
      </div>
    </div>
    <h2 class="text-2xl font-bold text-yellow-400 mb-3">Premium bob</h2>
    <p class="text-gray-300 mb-4 leading-relaxed">
      "<span id="pmTitle" class="text-white font-medium"></span>" mangasining
      <span id="pmChapter" class="text-yellow-300"></span>-bobi pullik kontent hisoblanadi.
    </p>
    <div class="bg-gray-700/50 rounded-lg p-4 mb-5 border border-gray-600/50">
      <p class="text-gray-200 text-lg">
        Narx: <span id="pmPrice" class="text-purple-400 font-bold">0</span> tanga
      </p>
    </div>

    <div class="flex flex-col sm:flex-row justify-center gap-2 sm:gap-3">
      <button id="pmBuyBtn"
              class="px-5 py-2.5 rounded-xl bg-purple-600 hover:bg-purple-700 transition-all flex items-center justify-center gap-2">
        <i class="fas fa-shopping-cart"></i><span>Sotib olish</span>
      </button>
      <button id="pmOpenCoinsBtn"
              class="px-5 py-2.5 rounded-xl bg-amber-600 hover:bg-amber-700 transition-all text-white flex items-center justify-center gap-2">
        <i class="fas fa-coins"></i><span>Tangalar sotib olish</span>
      </button>
      <button data-close-modal="#buyModal"
              class="px-5 py-2.5 rounded-xl bg-gray-600 hover:bg-gray-700 transition-all text-white flex items-center justify-center gap-2">
        <i class="fas fa-times"></i><span>Bekor qilish</span>
      </button>
    </div>
  </div>
</div>

<!-- ===== Coins Modal (global) ===== -->
<div id="coinsModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 p-4">
  <div class="mx-auto max-w-md w-full bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-6 sm:p-8 border border-purple-500/30 shadow-2xl shadow-purple-500/10 relative top-1/2 -translate-y-1/2">
    <div class="flex items-center gap-2 mb-4">
      <i class="fas fa-coins text-yellow-400 text-2xl"></i>
      <h3 class="text-2xl font-bold text-yellow-400">Tangalar sotib olish</h3>
    </div>

    <p class="text-gray-300 mb-4 leading-relaxed">
      Tangalarni sotib olish uchun Telegram orqali bog‘laning:
      <a href="https://t.me/mangalabuzadmin" target="_blank" class="text-sky-400 underline">@mangalabuzadmin</a>
    </p>

    <div class="bg-gray-800/70 rounded-xl border border-gray-700 p-4 space-y-2 mb-5">
      <div class="flex items-center justify-between px-3 py-2 rounded-lg bg-gray-800 border border-gray-700">
        <span class="flex items-center gap-2"><i class="fas fa-coins text-yellow-400"></i> 100 ta tanga</span>
        <span class="text-yellow-400 font-semibold">10 000 so‘m</span>
      </div>
      <div class="flex items-center justify-between px-3 py-2 rounded-lg bg-gray-800 border border-gray-700">
        <span class="flex items-center gap-2"><i class="fas fa-coins text-yellow-400"></i> 500 ta tanga</span>
        <span class="text-yellow-400 font-semibold">50 000 so‘m</span>
      </div>
      <div class="flex items-center justify-between px-3 py-2 rounded-lg bg-gray-800 border border-gray-700">
        <span class="flex items-center gap-2"><i class="fas fa-coins text-yellow-400"></i> 1000 ta tanga</span>
        <span class="text-yellow-400 font-semibold">100 000 so‘m</span>
      </div>
    </div>

    <div class="text-center">
      <button data-close-modal="#coinsModal"
              class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl bg-gray-600 hover:bg-gray-700 text-white">
        <i class="fas fa-times"></i><span>Yopish</span>
      </button>
    </div>
  </div>
</div>

<script>
  // ===== Global Premium Purchase Controller =====
  (function(){
    'use strict';

    // --- Elements
    const buyModal        = document.getElementById('buyModal');
    const coinsModal      = document.getElementById('coinsModal');
    const pmTitle         = document.getElementById('pmTitle');
    const pmChapter       = document.getElementById('pmChapter');
    const pmPrice         = document.getElementById('pmPrice');
    const pmBuyBtn        = document.getElementById('pmBuyBtn');
    const pmOpenCoinsBtn  = document.getElementById('pmOpenCoinsBtn');

    // Agar include yo'q bo'lsa, hech narsa qilmaymiz
    if (!buyModal || !coinsModal) return;

    let BUY_URL = "", READ_URL = "";

    // --- Helpers
    function getCookie(name){
      const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return m ? m.pop() : '';
    }
    function open(el){ el && el.classList.remove('hidden'); }
    function close(el){ el && el.classList.add('hidden'); }

    function toast(msg, ok){
      const t = document.createElement('div');
      t.className = 'fixed top-5 right-5 px-4 py-2 rounded shadow-lg text-white z-50 transition transform duration-300 ' + (ok?'bg-green-600':'bg-red-600');
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(-20px)'; setTimeout(()=>t.remove(), 300); }, 2500);
    }

    // --- Open from purchase buttons (delegation)
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.js-open-purchase');
      if(!btn) return;

      // Yangi atributlar
      const title  = btn.dataset.title || '';
      const ch     = btn.dataset.ch || btn.dataset.chapter || '';
      const price  = btn.dataset.price || '0';
      // Yangi/Eski URL atributlari
      BUY_URL      = btn.dataset.buyUrl   || btn.dataset.url || '';
      READ_URL     = btn.dataset.readUrl  || btn.dataset.chapterUrl || '';

      if (pmTitle)   pmTitle.textContent   = title;
      if (pmChapter) pmChapter.textContent = ch;
      if (pmPrice)   pmPrice.textContent   = price;

      open(buyModal);
    });

    // --- Footer va boshqa joylardan Coins modalni bevosita ochish
    document.addEventListener('click', (e)=>{
      const openCoins = e.target.closest('.js-open-coins');
      if (!openCoins) return;
      e.preventDefault();
      open(coinsModal);
    });

    // --- “Tangalar” tugmasi (buy modal ichidan)
    if (pmOpenCoinsBtn){
      pmOpenCoinsBtn.addEventListener('click', ()=>{
        close(buyModal);
        open(coinsModal);
      });
    }

    // --- [data-close-modal] delegatsiya
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-close-modal]');
      if (!btn) return;
      const sel = btn.getAttribute('data-close-modal');
      const el = document.querySelector(sel);
      close(el);
    });

    // --- Overlay click: modalni yopish
    [buyModal, coinsModal].forEach(m => {
      m.addEventListener('click', (e) => { if (e.target === m) close(m); });
    });

    // --- ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape'){ close(buyModal); close(coinsModal); }
    });

    // --- Xarid
    if (pmBuyBtn){
      pmBuyBtn.addEventListener('click', async function(){
        const self = this;
        if(!BUY_URL || self.disabled) return;

        const oldHTML = self.innerHTML;
        self.disabled = true;
        self.setAttribute('aria-busy', 'true');
        self.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Jarayonda…</span>';

        try{
          const res  = await fetch(BUY_URL, {
            method: 'POST',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': getCookie('csrftoken')
            }
          });
          const data = await res.json();

          if (data.need_coins){
            close(buyModal);
            open(coinsModal);
            toast(data.message || 'Tangalar yetarli emas', false);
            self.innerHTML = oldHTML; self.disabled = false; self.removeAttribute('aria-busy');
            return;
          }

          if (data.success){
            toast(data.message || 'Xarid muvaffaqiyatli', true);
            close(buyModal);

            // Sahifalar tinglashi uchun hodisa
            window.dispatchEvent(new CustomEvent('premium:purchase-success', {
              detail: { buyUrl: BUY_URL, readUrl: READ_URL, payload: data }
            }));

            if (READ_URL) { setTimeout(()=>{ window.location.href = READ_URL; }, 600); }
          } else {
            toast(data.message || 'Xarid amalga oshmadi', false);
            self.innerHTML = oldHTML; self.disabled = false; self.removeAttribute('aria-busy');
          }
        }catch(err){
          console.error(err);
          toast('Tarmoq xatosi. Qayta urinib ko‘ring.', false);
          self.innerHTML = oldHTML; self.disabled = false; self.removeAttribute('aria-busy');
        }
      });
    }

    // --- Global API (ixtiyoriy): qo‘l bilan chaqirish
    window.ML = window.ML || {};
    window.ML.openPremiumModal = function({title, chapter, price, buyUrl, readUrl}){
      if (pmTitle)   pmTitle.textContent   = title || '';
      if (pmChapter) pmChapter.textContent = chapter || '';
      if (pmPrice)   pmPrice.textContent   = price || '0';
      BUY_URL  = buyUrl || '';
      READ_URL = readUrl || '';
      open(buyModal);
    };
  })();
</script>


