{# 1â€“2 ta rasmni oldindan preload (ixtiyoriy) #}
{% for p in pages_payload|slice:":2" %}
<link rel="preload" as="image" href="{{ p.url }}">
{% endfor %}

{# JSON xavfsiz joyda #}
{{ pages_payload|json_script:"pages-data" }}

<style>
  /* --- Loader/Spinner uslublari --- */
  .page-container{
    position: relative;
    min-height: 240px; /* Rasm kelguncha bo'shliqqa "skelet" */
  }
  .page-loader{
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    padding: 24px 0;
  }
  .spinner{
    width: 48px;
    height: 48px;
    border: 4px solid rgba(0,0,0,.2);
    border-top-color: rgba(0,0,0,.6);
    border-radius: 50%;
    animation: spin .8s linear infinite;
  }
  @media (prefers-color-scheme: dark){
    .spinner{
      border-color: rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.85);
    }
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>

<div id="chapter-pages" class="sm:container mx-auto px-0 sm:px-4">
  {% for _ in pages %}
    <div class="flex justify-center page-container" data-page-index="{{ forloop.counter0 }}">
      <div class="page-loader"><div class="spinner"></div></div>
    </div>
  {% endfor %}
</div>

<script>
  // --- sozlamalar ---
  const PREFETCH_AHEAD = 2;      // yuklangan sahifadan keyin qancha fon prefetch
  const WARM_PREFETCH  = 3;      // sahifa ochilganda darhol fonâ€™da boshlab yuboriladiganlar
  const CONCURRENCY    = 4;      // bir vaqtning oâ€˜zida yuklanadigan rasmlar
  const ROOT_MARGIN    = '900px 0px'; // koâ€˜rinishga yaqinlashganda HIGH navbatga qoâ€˜yish

  const pages = JSON.parse(document.getElementById('pages-data').textContent);
  const container = document.getElementById('chapter-pages');

  // Navbatlar
  const hiQ = [];               // yuqori prioritet
  const lowQ = [];              // past prioritet (prefetch)
  const queued   = new Set();   // navbatga qoâ€˜yilgan indexlar
  const inflight = new Set();   // hozir yuklanayotgan indexlar
  const loaded   = new Set();   // yuklab boâ€˜lingan indexlar

  function enqueue(i, high = true){
    if (i < 0 || i >= pages.length) return;
    if (loaded.has(i) || inflight.has(i) || queued.has(i)) return;
    (high ? hiQ : lowQ).push(i);
    queued.add(i);
    pump();
  }

  // high flag yoâ€˜qolib ketmasligi uchun obyekt qaytaramiz
  function dequeue(){
    if (hiQ.length) return { i: hiQ.shift(), high: true };
    if (lowQ.length) return { i: lowQ.shift(), high: false };
    return null;
  }

  function pump(){
    while (inflight.size < CONCURRENCY){
      const item = dequeue();
      if (!item) break;
      startLoad(item.i, item.high);
    }
  }

  function startLoad(i, high){
    inflight.add(i);
    const wrap = container.querySelector(`.page-container[data-page-index="${i}"]`);
    if (!wrap){ inflight.delete(i); return; }

    const loader = wrap.querySelector('.page-loader');

    const img = document.createElement('img');
    img.alt = pages[i].alt || `Page ${i+1}`;
    img.decoding = 'async';
    // ðŸ‘‡ lazy ishlatilmaydi â€” faqat JS boshqaradi
    // img.loading = undefined;
    img.fetchPriority = high ? 'high' : 'low';  // brauzerga aniq hint
    img.referrerPolicy = 'no-referrer';
    img.draggable = false;
    img.className = 'w-full md:w-[400px] max-w-full h-auto transition-opacity duration-500 ease-in-out opacity-0 select-none';

    img.onload = () => {
      img.classList.add('opacity-100');
      loader.replaceWith(img);                 // spinner oâ€˜rniga rasm
      inflight.delete(i);
      loaded.add(i);
      // Ketma-ket keyingilarni fonâ€™da tayyorlab boramiz
      for (let k = 1; k <= PREFETCH_AHEAD; k++) enqueue(i + k, /*high=*/false);
      pump();
    };

    img.onerror = () => {
      // Foydalanuvchiga koâ€˜rinadigan xabar va qayta urinib koâ€˜rish tugmasi
      loader.innerHTML = '<button type="button" style="color:#b91c1c; text-decoration:underline">Yuklashda xatolik â€” qayta urinib koâ€˜rish</button>';
      const btn = loader.querySelector('button');
      if (btn){
        btn.addEventListener('click', () => {
          // xatodan keyin qayta urinish
          queued.delete(i);
          inflight.delete(i);
          enqueue(i, /*high=*/true);
        }, { once: true });
      } else {
        inflight.delete(i);
      }
      pump();
    };

    // Yuklashni shu yerda boshlaymiz
    img.src = pages[i].url;
  }

  // Koâ€˜rinishga kirganda â€” birinchi boâ€˜lib HIGH navbatga
  const io = ('IntersectionObserver' in window)
    ? new IntersectionObserver((entries) => {
        // koâ€˜rinishga eng yaqinini oldin qoâ€˜yish
        const h = (window.innerHeight || document.documentElement.clientHeight) / 2;
        entries
          .filter(e => e.isIntersecting)
          .sort((a,b) => Math.abs(a.target.getBoundingClientRect().top - h)
                       - Math.abs(b.target.getBoundingClientRect().top - h))
          .forEach(e => {
            const i = parseInt(e.target.getAttribute('data-page-index'), 10);
            enqueue(i, /*high=*/true);
            // shu sahifadan keyingi bittasini fonâ€™da tayyorlab boramiz
            enqueue(i + 1, /*high=*/false);
          });
      }, { root: null, rootMargin: ROOT_MARGIN, threshold: 0.01 })
    : null;

  // Barcha konteynerlarni kuzatamiz (fallback: IO boâ€˜lmasa ham ishlaydi)
  const nodes = container.querySelectorAll('.page-container');
  nodes.forEach(el => io ? io.observe(el) : enqueue(parseInt(el.getAttribute('data-page-index'), 10), true));

  // Warm start: sahifa ochilishi bilan yuqori + fon navbatini ishga tushiramiz
  window.addEventListener('DOMContentLoaded', () => {
    enqueue(0, /*high=*/true);                      // birinchi elementni majburan
    for (let j = 1; j <= WARM_PREFETCH; j++) enqueue(j, /*high=*/false);  // fon prefetch
    pump();
  });

  // anti-save mayda choralar
  document.addEventListener('contextmenu', e => e.preventDefault(), {passive:false});
  document.addEventListener('dragstart',  e => e.preventDefault(), {passive:false});
</script>
