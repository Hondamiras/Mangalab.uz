{% extends "base.html" %}
{% load static %}
{% load cache %}

{% block content %}
<style>
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { scrollbar-width: none; -ms-overflow-style: none; }
  .row-scroll { overflow-x: auto; overflow-y: hidden; }
</style>
<style>
  .navbtn{
    border-radius: 0.75rem;
    padding: .5rem;
    background: #1f2937;        /* bg-gray-800 */
    color: #e5e7eb;             /* text-gray-200 */
    border: 1px solid rgba(255,255,255,.25);
    transition: background .2s ease;
  }
  .navbtn:hover{ background:#374151; }  /* hover:bg-gray-700 */
  .navbtn:disabled{ opacity:.4; cursor:not-allowed; }
  .navbtn:focus{
    outline: 2px solid #ffffff;
    outline-offset: 2px;
  }
  .navbtn svg{ width: 1.25rem; height: 1.25rem; display:block; }
</style>

<div class="mx-auto px-4 py-6 sm:px-20">

{% cache 3600 trending_manga_section %}
<section aria-labelledby="trending-title" class="mb-10">
  <div class="flex items-center justify-between mb-3">
    <h2 id="trending-title" class="text-lg sm:text-xl font-semibold text-white tracking-tight">
      <span class="inline-flex items-center gap-2">
        <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 24 24" fill="currentColor"><path d="M13 2L3 14h7v8l11-14h-8z"/></svg>
        Trenddagi taytlar
      </span>
    </h2>
    <div class="flex items-center gap-2">
      <button id="trendingPrev" class="navbtn" aria-label="Oldingi">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M15 19l-7-7 7-7" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <button id="trendingNext" class="navbtn" aria-label="Keyingi">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M9 5l7 7-7 7" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="relative">
    <div id="trendingRow" class="row-scroll no-scrollbar flex gap-4 overflow-x-auto snap-x snap-mandatory scroll-p-4 pr-1" role="list">
      {% for manga in trending_mangas %}
        <div role="listitem" class="snap-start w-36 sm:w-40 flex-shrink-0">
          <a href="{% url 'manga:manga_details' manga.slug %}">
            <div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg">
              <div class="relative aspect-[3/4]">
                <img src="{{ manga.cover_image.url }}" alt="{{ manga.title }}" class="w-full h-full object-cover">
                <div class="absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t from-black to-transparent">
                  <h3 class="text-white text-sm font-semibold truncate">{{ manga.title }}</h3>
                  <div class="flex justify-between items-center text-xs mt-1">
                    <span class="text-gray-300">{{ manga.type }}</span>
                    <span class="text-purple-300">{{ manga.chapters.count }} Bob</span>
                  </div>
                </div>
              </div>
            </div>
          </a>
        </div>
      {% endfor %}
    </div>
  </div>
</section>
{% endcache %}

{% if active_progress %}
<section aria-labelledby="reading-title" class="mb-10">
  <div class="flex items-center justify-between mb-3">
    <h2 id="reading-title" class="text-lg sm:text-xl font-semibold text-white tracking-tight">
      <span class="inline-flex items-center gap-2">
        <svg class="h-5 w-5 text-blue-400" viewBox="0 0 24 24" fill="currentColor">
          <path d="M3 4c0-1.1.9-2 2-2h6v18H5c-1.1 0-2-.9-2-2V4zm10-2h6c1.1 0 2 .9 2 2v14c0 1.1-.9 2-2 2h-6V2z"/>
        </svg>
        Hozir o‘qilayotganlar
      </span>
    </h2>
    <div class="flex items-center gap-2">
      <button id="readingPrev" class="navbtn" aria-label="Oldingi">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M15 19l-7-7 7-7" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <button id="readingNext" class="navbtn" aria-label="Keyingi">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M9 5l7 7-7 7" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>

  <div id="readingRow"
      class="row-scroll no-scrollbar flex gap-4 overflow-x-auto snap-x snap-mandatory scroll-p-4 pr-1"
      role="list">
    {% for item in active_progress %}
      <div role="listitem" class="snap-start w-36 sm:w-40 flex-shrink-0">
        <a href="{% url 'manga:manga_details' item.manga.slug %}">
          <div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg">
            <div class="relative aspect-[3/4]">
              <img src="{{ item.manga.cover_image.url }}" alt="{{ item.manga.title }}" class="w-full h-full object-cover">
              <div class="absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t from-black to-transparent">
                <h3 class="text-white text-sm font-semibold truncate">{{ item.manga.title }}</h3>
                <div class="flex justify-between items-center text-xs mt-1">
                  <span class="text-gray-300">{{ item.manga.type }}</span>
                  <span class="text-purple-300">{{ item.manga.chapters.count }} bob</span>
                </div>
              </div>
            </div>
          </div>
        </a>
      </div>
    {% endfor %}
  </div>
</section>
{% endif %}

{% cache 300 'top_translators_section' %}
<section aria-labelledby="translators-title" class="mb-10">
  <div class="flex items-center justify-between mb-3">
    <h2 id="translators-title" class="text-lg sm:text-xl font-semibold text-white tracking-tight">
      <span class="inline-flex items-center gap-2">
        <svg class="h-5 w-5 text-amber-400" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M17 3V2H7v1H3v4a4 4 0 004 4h1.1A5.002 5.002 0 0011 15v3H8v2h8v-2h-3v-3a5.002 5.002 0 002.9-4H17a4 4 0 004-4V3h-4zM7 9a2 2 0 01-2-2V5h2v4zm12-2a2 2 0 01-2 2V5h2v2z"/>
        </svg>
        Top 4 tarjimon
      </span>
    </h2>
    <a href="{% url 'accounts:top_translators' %}"
      class="text-sm text-purple-300 hover:text-purple-100 underline underline-offset-4">
      Hammasi →
    </a>
  </div>

  <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
    {% for t in top_translators|slice:":4" %}
    <a href="{% url 'accounts:translator_profile' t.user.username %}"
      class="group relative rounded-xl bg-gray-800 border border-gray-700 hover:border-amber-500 p-4 text-center transition shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-amber-500">
      <div class="relative mx-auto w-16 h-16 mb-3">
        {% if t.avatar %}
          <img src="{{ t.avatar.url }}" alt="{{ t.user.username }}"
              class="w-full h-full rounded-full object-cover border-2 border-amber-500">
        {% else %}
          <div class="w-full h-full rounded-full bg-gray-700 flex items-center justify-center border-2 border-amber-500">
            <span class="text-xl font-bold text-white">{{ t.user.username|first|upper }}</span>
          </div>
        {% endif %}
        <div class="absolute -bottom-2 right-0">
          <span class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-bold bg-purple-600 text-purple-50">
            #{{ forloop.counter }}
          </span>
        </div>
      </div>

      <h3 class="font-semibold text-white text-sm truncate" title="{{ t.user.username }}">{{ t.user.username }}</h3>

      <div class="mt-2 flex items-center justify-center gap-3 text-[11px] text-gray-300">
        <span class="inline-flex items-center gap-1" title="Loyihalar soni">
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M18 2H8a2 2 0 00-2 2v15a3 3 0 012-2.82V4h10v14h2V4a2 2 0 00-2-2zM6 6H4v14a2 2 0 002 2h10v-2H6V6z"/></svg>
          {{ t.manga_count|default:"0" }}
        </span>
        <span class="inline-flex items-center gap-1" title="Obunachilar">
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zM8 11c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm8 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
          {{ t.follower_count|default:"0" }}
        </span>
        <span class="inline-flex items-center gap-1" title="Like/Thanks">
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12.1 8.64l-.1.1-.11-.1C10.14 6.6 7.1 6.24 5.14 8.2c-2.07 2.07-1.48 5.44 1.06 7.32L12 21l5.8-5.48c2.54-1.88 3.13-5.25 1.06-7.32-1.96-1.96-5-1.6-6.76.44z"/></svg>
          {{ t.likes_count|default:"0" }}
        </span>
      </div>
    </a>
    {% endfor %}
  </div>
</section>
{% endcache %}


<section aria-labelledby="recent-title" class="mb-10">
  <div class="flex items-center justify-between mb-3">
    <h2 id="recent-title" class="text-lg sm:text-xl font-semibold text-white tracking-tight">
      <span class="inline-flex items-center gap-2">
        <svg class="h-5 w-5 text-sky-400" viewBox="0 0 24 24" fill="currentColor">
          <path d="M3 12l9-9 9 9-9 9-9-9z"/>
        </svg>
        Yaqinda qo‘shilganlar
      </span>
    </h2>
  </div>

  {# Desktop sarlavha qatori #}
  <div class="hidden md:grid md:grid-cols-12 px-3 py-2 border-b border-gray-800 text-gray-400 text-sm">
    <div class="col-span-5">Taytl</div>
    <div class="col-span-4 text-center"></div>
    <div class="col-span-3 text-right">Yangilangan vaqti</div>
  </div>

  <div class="flex flex-col divide-y divide-gray-800">
    {% for item in recent_feed %}
      {% with m=item.manga chs=item.chapters last=item.last total=item.total more=item.more %}
      {# ===================== Mobile (≤ md) kartochka ===================== #}
      <div class="md:hidden px-3 py-3">
        <div class="grid grid-cols-[72px,1fr] gap-3">
          <a href="{% url 'manga:manga_details' m.slug %}" class="col-span-1">
            <img src="{{ m.cover_image.url }}" alt="{{ m.title }}"
                 class="w-[72px] h-[100px] rounded-lg object-cover shadow" loading="lazy">
          </a>

          <div class="col-span-1 min-w-0">
            <div class="flex items-center justify-between text-[11px] text-gray-400 mb-1">
              <span class="truncate">{{ m.type }}</span>
              <span class="flex items-center gap-1 shrink-0">
                <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 8V12l3 3 1-1-3-3V8z"/><path d="M12 2a10 10 0 100 20 10 10 0 000-20z"/>
                </svg>
                {{ item.ago }}
              </span>
            </div>

            <a href="{% url 'manga:manga_details' m.slug %}"
               class="block text-white font-semibold text-[15px] leading-snug line-clamp-2 hover:underline">
              {{ m.title }}
            </a>

            <div class="mt-2 flex flex-wrap gap-1.5">
              {% for c in chs %}
                <a href="{% url 'manga:chapter_read' m.slug c.obj.volume c.obj.chapter_number %}"
                   class="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-gray-800/80 hover:bg-gray-700 text-[12px] text-purple-200">
                  <span>Bob {{ c.obj.chapter_number }}</span>
                </a>
              {% endfor %}

              {% if more %}
                <a href="{% url 'manga:manga_details' m.slug %}"
                   class="inline-flex items-center px-2 py-1 rounded-md text-[12px] text-gray-300 underline">
                  Yana {{ more }}…
                </a>
              {% elif total > chs|length %}
                <a href="{% url 'manga:manga_details' m.slug %}"
                   class="inline-flex items-center px-2 py-1 rounded-md text-[12px] text-gray-300 underline">
                  Yana boblar…
                </a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      {# ===================== Desktop (md+) eski qatordagi dizayn ===================== #}
      <div class="hidden md:grid md:grid-cols-12 gap-3 px-3 py-4">
        <!-- Cover -->
        <a href="{% url 'manga:manga_details' m.slug %}" class="md:col-span-1">
          <img src="{{ m.cover_image.url }}" alt="{{ m.title }}"
               class="w-16 h-24 rounded-lg object-cover shadow" loading="lazy">
        </a>

        <!-- Chap blok -->
        <div class="md:col-span-4 min-w-0">
          <a href="{% url 'manga:manga_details' m.slug %}"
             class="block text-white font-semibold text-lg truncate hover:underline">
            {{ m.title }}
          </a>
          <div class="text-gray-400 text-sm mt-1">
            {{ total }} ta yangi bob
          </div>
        </div>

        <!-- O‘rta blok: oxirgi 3 bob -->
        <div class="md:col-span-5">
          <div class="w-full">
            {% for c in chs %}
              <div class="flex items-center py-1.5">
                {% if c.translators %}
                  <div class="-space-x-2 flex flex-shrink-0">
                    {% for t in c.translators %}
                      {% if t.avatar %}
                        <img src="{{ t.avatar.url }}" class="w-6 h-6 rounded-full ring-1 ring-gray-900"
                             alt="{{ t.user.username }}" title="{{ t.user.username }}">
                      {% else %}
                        <div title="{{ t.user.username }}"
                             class="w-6 h-6 rounded-full ring-1 ring-gray-900 bg-gray-700 text-white text-[10px] flex items-center justify-center">
                          {{ t.user.username|first|upper }}
                        </div>
                      {% endif %}
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="w-6"></div>
                {% endif %}

                <a href="{% url 'manga:chapter_read' m.slug c.obj.volume c.obj.chapter_number %}"
                   class="ml-3 text-sm text-purple-200 hover:text-purple-100 truncate">
                  {% if c.obj.volume %}Jild {{ c.obj.volume }}.{% endif %} Bob {{ c.obj.chapter_number }}
                </a>
              </div>
            {% endfor %}

            {% if more %}
              <div class="pt-1">
                <a href="{% url 'manga:manga_details' m.slug %}"
                   class="ml-9 text-xs text-gray-400 hover:text-gray-200">
                  Yana {{ more }} bob…
                </a>
              </div>
            {% elif total > chs|length %}
              <div class="pt-1">
                <a href="{% url 'manga:manga_details' m.slug %}"
                   class="ml-9 text-xs text-gray-400 hover:text-gray-200">
                  Yana boblar…
                </a>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- O‘ng blok: vaqt -->
        <div class="md:col-span-2 flex items-start justify-end">
          <div class="text-gray-400 text-sm flex items-center gap-1">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 8V12l3 3 1-1-3-3V8z"/>
              <path d="M12 2a10 10 0 100 20 10 10 0 000-20zM12 20a8 8 0 110-16 8 8 0 010 16z"/>
            </svg>
            {{ item.ago }}
          </div>
        </div>
      </div>
      {% endwith %}
    {% empty %}
      <div class="px-3 py-6 text-gray-400">Hozircha yangilanish yo‘q.</div>
    {% endfor %}
  </div>
</section>



</div>

<script>
  (function () {
    // Bitta karuselni ulash
    function wire(base) {
      const row  = document.getElementById(base + 'Row');
      const prev = document.getElementById(base + 'Prev');
      const next = document.getElementById(base + 'Next');
      if (!row || !prev || !next) return;

      const update = () => {
        const max = Math.max(0, row.scrollWidth - row.clientWidth - 1);
        prev.disabled = row.scrollLeft <= 0;
        next.disabled = row.scrollLeft >= max;
      };

      const scrollByPage = (dir) =>
        row.scrollBy({ left: dir * row.clientWidth, behavior: 'smooth' });

      prev.addEventListener('click', () => scrollByPage(-1));
      next.addEventListener('click', () => scrollByPage(1));

      // Performance uchun passiv listener
      row.addEventListener('scroll', update, { passive: true });
      window.addEventListener('resize', update);

      // Ba’zi brauzerlarda scroll tugaganini ushlash (agar bo‘lsa)
      row.addEventListener?.('scrollend', update);

      // Dastlabki holat
      requestAnimationFrame(update);
    }

    // ID nomlash sharti: <prefix>Row / <prefix>Prev / <prefix>Next
    // Masalan: trendingRow, trendingPrev, trendingNext
    const bases = new Set(
      Array.from(
        document.querySelectorAll('button.navbtn[id$="Prev"], button.navbtn[id$="Next"]')
      ).map(btn => btn.id.replace(/(Prev|Next)$/, ''))
    );

    bases.forEach(wire);
  })();
</script>

{% endblock %}
