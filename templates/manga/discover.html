{% extends "base.html" %}
{% load static %}
{% load cache %}

{% block content %}
<style>
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { scrollbar-width: none; -ms-overflow-style: none; }
  .row-scroll { overflow-x: auto; overflow-y: hidden; }
</style>
<style>
  .navbtn{
    border-radius: 0.75rem;
    padding: .5rem;
    background: #1f2937;        /* bg-gray-800 */
    color: #e5e7eb;             /* text-gray-200 */
    border: 1px solid rgba(255,255,255,.25);
    transition: background .2s ease;
  }
  .navbtn:hover{ background:#374151; }  /* hover:bg-gray-700 */
  .navbtn:disabled{ opacity:.4; cursor:not-allowed; }
  .navbtn:focus{
    outline: 2px solid #ffffff;
    outline-offset: 2px;
  }
  .navbtn svg{ width: 1.25rem; height: 1.25rem; display:block; }
</style>

<div class="mx-auto px-4 py-6 sm:px-20">
  {# ========= HERO: To‘liq karta + karusel ========= #}
{% if hero_posters %}
<section id="hero" class="mb-8">
  <style>
    /* ================== HERO: VIEWPORT & TRACK ================== */
    #heroViewport{
      position:relative;
      overflow:hidden;
      border-radius:20px;
      touch-action: pan-y;
      --step: 100%;

      --nav-btn: 42px;
      --nav-gap: 16px;
      --nav-safe: calc(var(--nav-btn) + var(--nav-gap) + 12px);
    }
    #heroTrack{
      display:flex;
      transform: translateX(calc(var(--slide,0) * -1 * var(--step)));
      transition: transform .60s cubic-bezier(.22,.61,.36,1);
      position:relative;
      z-index:1;
      will-change: transform;
    }
    .heroSlide{ min-width:100%; }

    /* ================== CARD BACKGROUND ================== */
    .heroWrap{
      position:relative;
      isolation:isolate;
      border-radius:20px;
      background:
        radial-gradient(80% 140% at 110% 20%, rgba(255,255,255,.12), transparent 60%),
        radial-gradient(80% 100% at -10% 120%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(135deg, #7c3aed 0%, #6d28d9 35%, #4c1d95 70%, #0b1220 100%);
      border:1px solid rgba(148,163,184,.22);
      box-shadow: 0 20px 45px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
    }
    .heroWrap::before{
      content:"";
      position:absolute;
      inset:-30%;
      background:
        radial-gradient(40rem 20rem at 15% 10%, rgba(255,255,255,.12), transparent 60%),
        radial-gradient(28rem 18rem at 85% 90%, rgba(255,255,255,.08), transparent 60%);
      filter: blur(4px);
      pointer-events:none;
      z-index:0;
      border-radius:inherit;
    }

    /* ================== LAYOUT ================== */
    .heroClamp{ max-width:1100px; margin-inline:auto; }
    .heroGrid{
      --poster-w: 116px;
      display:grid;
      align-items:flex-start;
      grid-template-columns: minmax(0,1fr) var(--poster-w);
      gap:.85rem;
      position:relative;
    }
    @media (min-width:640px){ .heroGrid{ --poster-w:136px; gap:1.05rem; } }
    @media (min-width:768px){ .heroGrid{ --poster-w:190px; gap:1.15rem; } }

    .textClamp{
      max-width: 62ch;
      position:relative;
      z-index:1;
    }
    .heroText{
      display:flex;
      flex-direction:column;
      gap:.55rem;
    }
    @media (min-width:768px){ .heroText{ gap:.6rem; } }

    /* ================== TEXT CLAMP ================== */
    .heroTitle{
      display:-webkit-box;
      -webkit-box-orient:vertical;
      overflow:hidden;
      -webkit-line-clamp:2;
    }
    @media (min-width:1024px){
      .heroTitle{ -webkit-line-clamp:2; }
    }

    .heroDesc{
      display:-webkit-box;
      -webkit-box-orient:vertical;
      overflow:hidden;
      -webkit-line-clamp:4;
      opacity:.92;
    }
    @media (min-width:640px){
      .heroDesc{ -webkit-line-clamp:5; }
    }
    @media (min-width:1024px){
      .heroDesc{ -webkit-line-clamp:6; }
    }

    /* ================== MANGA METADATA ================== */
    .mangaMeta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }
    .metaBadge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.35rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      line-height: 1;
      white-space: nowrap;
    }
    .metaType {
      background: rgba(168, 85, 247, 0.25);
      border: 1px solid rgba(168, 85, 247, 0.4);
      color: #e9d5ff;
    }
    .metaStatus {
      background: rgba(245, 158, 11, 0.25);
      border: 1px solid rgba(245, 158, 11, 0.4);
      color: #fed7aa;
    }
    .metaRating {
      background: rgba(34, 197, 94, 0.25);
      border: 1px solid rgba(34, 197, 94, 0.4);
      color: #bbf7d0;
    }
    .metaIcon {
      width: 0.875rem;
      height: 0.875rem;
      flex-shrink: 0;
    }

    /* ================== POSTER ================== */
    .heroPoster{
      position:relative;
      width:var(--poster-w);
      aspect-ratio:3/4;
      z-index:1;
      flex:none;
    }
    .heroPoster img{
      width:100%;
      height:100%;
      object-fit:cover;
      border-radius:14px;
      display:block;
      filter:saturate(1.08) contrast(1.02) drop-shadow(0 18px 30px rgba(0,0,0,.40));
      transform: translateZ(0);
    }
    .heroPoster::after{
      content:"";
      position:absolute;
      inset:-10%;
      background: radial-gradient(60% 70% at 60% 35%, rgba(168,85,247,.42), transparent 70%);
      filter: blur(18px);
      z-index:-1;
      pointer-events:none;
    }

    /* ================== DOTS (faqat phone) ================== */
    .dots{ gap:.5rem; display:flex; }
    .dot{ width:.58rem; height:.58rem; border-radius:9999px; background:#9ca3af; opacity:.75; }
    .dot[aria-current="true"]{ background:#f59e0b; opacity:1; }
    @media (min-width:768px){ .dots{ display:none !important; } }

    /* ================== NAV BUTTONS (desktop/tablet) ================== */
    .navBtn{
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      width:42px;
      height:42px;
      border-radius:9999px;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(6px);
      box-shadow:0 10px 25px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
      color:#fff;
      cursor:pointer;
      pointer-events:auto;
      z-index:5;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      transition: transform .18s ease, background .18s ease, opacity .18s ease;
      opacity:.85;
    }
    .navBtn:hover{ background:rgba(255,255,255,.12); opacity:1; transform:translateY(-50%) scale(1.03); }
    .navBtn[disabled]{ opacity:.35; cursor:not-allowed; transform:translateY(-50%); }
    #heroPrev{ left:16px; }
    #heroNext{ right:16px; }
    @media (min-width:768px){ .navBtn{ display:flex; } }

    /* ================== DESKTOP (2 slides) + poster kichikroq ================== */
    @media (min-width:1024px){
      #heroViewport{ --step:50%; }
      .heroSlide{
        min-width:50%;
        padding-left: max(2rem, var(--nav-safe)) !important;
        padding-right:max(2rem, var(--nav-safe)) !important;
      }

      .heroGrid{ --poster-w:170px; gap:1.1rem; }
      .heroClamp{ max-width:980px; }

      /* Tipografiya (professional) */
      #hero .heroTitle{ font-size: clamp(1.7rem, 1.8vw, 2.2rem); line-height:1.18; }
      #hero .heroDesc { font-size: 1.02rem; line-height:1.75; max-width: 64ch; }
    }
    @media (min-width:1280px){
      .heroGrid{ --poster-w:190px; gap:1.25rem; }
      .heroClamp{ max-width:1040px; }
    }
    @media (min-width:1536px){
      .heroGrid{ --poster-w:205px; }
      .heroClamp{ max-width:1120px; }
    }

    @media (prefers-reduced-motion:reduce){
      #heroTrack{ transition:none; }
    }
  </style>

  <div id="heroViewport" class="heroWrap" tabindex="0" aria-label="Hero carousel">
    <div id="heroTrack" style="--slide:0;">
      {% for m in hero_posters %}
        <article class="heroSlide px-4 py-5 sm:px-6 sm:py-6 lg:py-7">
          <div class="heroClamp">
            <div class="heroGrid">
              <!-- Chap: matn -->
              <div class="textClamp heroText">
                <a href="{% url 'manga:manga_details' m.slug %}"
                  class="inline-block focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300/60 rounded">
                  <h2 class="heroTitle text-white font-extrabold">
                    {{ m.title }}
                  </h2>
                </a>

                <!-- Manga metadata: type, status, rating -->
                <div class="mangaMeta">
                  {% if m.type %}
                  <span class="metaBadge metaType">
                    <svg class="metaIcon" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M9 4v1.38c-.83-.33-1.72-.5-2.61-.5-1.79 0-3.58.68-4.95 2.05l3.33 3.33h1.11v1.11c.86.86 1.98 1.31 3.11 1.36V15H6v3c0 1.1.9 2 2 2h10c1.66 0 3-1.34 3-3V4H9zm-1.11 6.41V8.26H5.61L4.57 7.22a5.07 5.07 0 0 1 1.82-.34c1.34 0 2.59.52 3.54 1.46l1.41 1.41-.2.2a2.7 2.7 0 0 1-1.92.8c-.47 0-.93-.12-1.33-.34zM19 17c0 .55-.45 1-1 1s-1-.45-1-1v-2h-6v-2.59c.57-.23 1.1-.57 1.56-1.03l.2-.2L15.59 14H17v-1.41l-6-5.97V6h8v11z"/>
                    </svg>
                    {{ m.get_type_display }}
                  </span>
                  {% endif %}
                  
                  {% if m.status %}
                  <span class="metaBadge metaStatus">
                    <svg class="metaIcon" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    {{ m.get_status_display }}
                  </span>
                  {% endif %}
                  
                  {% if m.rating %}
                  <span class="metaBadge metaRating">
                    <svg class="metaIcon" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                    </svg>
                    {{ m.rating }}/10
                  </span>
                  {% endif %}
                </div>

                <p class="heroDesc text-gray-100/90">
                  {{ m.description|default_if_none:''|striptags }}
                </p>
              </div>

              <!-- O‘ng: poster -->
              <a href="{% url 'manga:manga_details' m.slug %}"
                class="block justify-self-end self-start focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300/60 rounded-xl">
                <div class="heroPoster">
                  <img src="{{ m.cover_image.url }}" alt="{{ m.title }}">
                </div>
              </a>
            </div>
          </div>
        </article>
      {% endfor %}
    </div>

    <!-- Prev/Next -->
    <button id="heroPrev" type="button" class="navBtn" aria-label="Oldingi" title="Oldingi">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
      </svg>
    </button>
    <button id="heroNext" type="button" class="navBtn" aria-label="Keyingi" title="Keyingi">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"/>
      </svg>
    </button>

    <!-- Dots (phone) -->
    <div class="absolute bottom-4 md:bottom-5 left-0 right-0 flex justify-center dots">
      {% for _ in hero_posters %}
        <button type="button" class="dot" data-index="{{ forloop.counter0 }}"
                {% if forloop.first %}aria-current="true"{% endif %}></button>
      {% endfor %}
    </div>
  </div>

  <script>
  (function(){
    const track   = document.getElementById('heroTrack');
    const view    = document.getElementById('heroViewport');
    const slides  = Array.from(track.children);
    const dots    = Array.from(view.querySelectorAll('.dot'));
    const prevBtn = document.getElementById('heroPrev');
    const nextBtn = document.getElementById('heroNext');

    let i = 0, N = slides.length;

    const isDesktop = () => window.matchMedia('(min-width:1024px)').matches;
    const visible   = () => isDesktop() ? 2 : 1;
    const maxIndex  = () => Math.max(0, N - visible());

    function syncDots(){
      if (!dots.length) return;
      dots.forEach((d, idx) => {
        if (idx === i) d.setAttribute('aria-current', 'true');
        else d.removeAttribute('aria-current');
      });
    }

    function update(){
      if (i > maxIndex()) i = maxIndex();
      if (i < 0) i = 0;
      track.style.setProperty('--slide', i);
      syncDots();
      prevBtn?.toggleAttribute('disabled', i === 0);
      nextBtn?.toggleAttribute('disabled', i === maxIndex());
    }

    function go(n){ i = Math.min(Math.max(0, n), maxIndex()); update(); }

    /* ✅ AUTOPLAY sekinroq */
    const AUTOPLAY_MS = 7500;
    const prefersReduce = window.matchMedia('(prefers-reduced-motion: reduce)');
    let timer = null;

    function startAuto(){
      if (prefersReduce.matches) return;
      if (N <= visible()) return;
      clearInterval(timer);
      timer = setInterval(() => {
        i = (i >= maxIndex()) ? 0 : i + 1;
        update();
      }, AUTOPLAY_MS);
    }
    function stopAuto(){ clearInterval(timer); timer = null; }

    // Dots (phone)
    dots.forEach(d => d.addEventListener('click', () => {
      go(parseInt(d.dataset.index || '0', 10));
      startAuto();
    }));

    // Buttons
    prevBtn?.addEventListener('click', (e)=>{ e.preventDefault(); go(i-1); startAuto(); });
    nextBtn?.addEventListener('click', (e)=>{ e.preventDefault(); go(i+1); startAuto(); });

    // Keyboard
    view.addEventListener('keydown', (e)=>{
      if(e.key==='ArrowRight'){ go(i+1); startAuto(); }
      else if(e.key==='ArrowLeft'){ go(i-1); startAuto(); }
    });

    // Swipe
    let startX=null, swiping=false, swiped=false, pid=null;
    const THRESH = 40;

    function isUiControl(el){ return !!el.closest('.navBtn, .dot, a, button'); }

    view.addEventListener('pointerdown', e => {
      if (isUiControl(e.target)) return;
      stopAuto();
      startX = e.clientX; swiping = true; swiped = false; pid = e.pointerId;
      try{ view.setPointerCapture(pid); }catch(_){}
    });

    view.addEventListener('pointerup', e => {
      if (!swiping) return;
      const dx = e.clientX - startX;
      if (Math.abs(dx) > THRESH) { swiped = true; dx < 0 ? go(i+1) : go(i-1); }
      try{ view.releasePointerCapture(pid); }catch(_){}
      startX=null; swiping=false; pid=null;
      startAuto();
    });

    view.addEventListener('click', (e)=>{
      if (swiped) { e.preventDefault(); e.stopPropagation(); swiped=false; }
    }, true);

    // Pause/resume
    view.addEventListener('mouseenter', stopAuto);
    view.addEventListener('mouseleave', startAuto);
    view.addEventListener('focusin', stopAuto);
    view.addEventListener('focusout', ()=>{ if(!view.contains(document.activeElement)) startAuto(); });

    document.addEventListener('visibilitychange', ()=>{ document.hidden ? stopAuto() : startAuto(); });
    window.addEventListener('resize', ()=>{ update(); startAuto(); });

    update();
    startAuto();
  })();
  </script>
</section>
{% endif %}



  {# ===================== Trenddagi taytlar ===================== #}
  {% cache 3600 trending_manga_section %}
  <section aria-labelledby="trending-title" class="mb-10">
    <div class="flex items-center justify-between mb-3">
      <h2 id="trending-title" class="text-lg sm:text-xl font-semibold text-white tracking-tight">
        <span class="inline-flex items-center gap-2">
          Trenddagi taytlar
        </span>
      </h2>
      <div class="flex items-center gap-2">
        <button id="trendingPrev" class="navbtn" aria-label="Oldingi">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M15 19l-7-7 7-7" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button id="trendingNext" class="navbtn" aria-label="Keyingi">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M9 5l7 7-7 7" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="relative">
      <div id="trendingRow" class="row-scroll no-scrollbar flex gap-4 overflow-x-auto snap-x snap-mandatory scroll-p-4 pr-1" role="list">
        {% for manga in trending_mangas %}
          <div role="listitem" class="snap-start w-36 sm:w-40 flex-shrink-0">
            <a href="{% url 'manga:manga_details' manga.slug %}">
              <div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg">
                <div class="relative aspect-[3/4]">
                  <img src="{{ manga.cover_image.url }}" alt="{{ manga.title }}" class="w-full h-full object-cover">
                  <div class="absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t from-black to-transparent">
                    <h3 class="text-white text-sm font-semibold truncate">{{ manga.title }}</h3>
                    <div class="flex justify-between items-center text-xs mt-1">
                      <span class="text-gray-300">{{ manga.type }}</span>
                      <span class="text-purple-300">{{ manga.chapters.count }} Bob</span>
                    </div>
                  </div>
                </div>
              </div>
            </a>
          </div>
        {% endfor %}
      </div>
    </div>
  </section>
  {% endcache %}

  {% if active_progress %}
  <section aria-labelledby="reading-title" class="mb-10">
    <div class="flex items-center justify-between mb-3">
      <h2 id="reading-title" class="text-lg sm:text-xl font-semibold text-white tracking-tight">
          Hozir o‘qilayotganlar
        </span>
      </h2>
      <div class="flex items-center gap-2">
        <button id="readingPrev" class="navbtn" aria-label="Oldingi">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M15 19l-7-7 7-7" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button id="readingNext" class="navbtn" aria-label="Keyingi">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M9 5l7 7-7 7" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>

    <div id="readingRow"
        class="row-scroll no-scrollbar flex gap-4 overflow-x-auto snap-x snap-mandatory scroll-p-4 pr-1"
        role="list">
      {% for item in active_progress %}
        <div role="listitem" class="snap-start w-36 sm:w-40 flex-shrink-0">
          <a href="{% url 'manga:manga_details' item.manga.slug %}">
            <div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg">
              <div class="relative aspect-[3/4]">
                <img src="{{ item.manga.cover_image.url }}" alt="{{ item.manga.title }}" class="w-full h-full object-cover">
                <div class="absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t from-black to-transparent">
                  <h3 class="text-white text-sm font-semibold truncate">{{ item.manga.title }}</h3>
                  <div class="flex justify-between items-center text-xs mt-1">
                    <span class="text-gray-300">{{ item.manga.type }}</span>
                    <span class="text-purple-300">{{ item.manga.chapters.count }} bob</span>
                  </div>
                </div>
              </div>
            </div>
          </a>
        </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  {# ===================== Eng yaxshi tarjimonlar ===================== #}
  {% cache 300 'top_translators_section' %}
  <section aria-labelledby="translators-title" class="mb-10">
    <div class="flex items-center justify-between mb-3">
      <h2 id="translators-title" class="text-lg sm:text-xl font-semibold text-white tracking-tight">
        <span class="inline-flex items-center gap-2">
          Top 4 tarjimon
        </span>
      </h2>
      <a href="{% url 'accounts:top_translators' %}"
        class="text-sm text-purple-300 hover:text-purple-100 underline underline-offset-4">
        Hammasi →
      </a>
    </div>

    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
      {% for t in top_translators|slice:":4" %}
      <a href="{% url 'accounts:translator_profile' t.user.username %}"
        class="group relative rounded-xl bg-gray-800 border border-gray-700 hover:border-amber-500 p-4 text-center transition shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-amber-500">
        <div class="relative mx-auto w-16 h-16 mb-3">
          {% if t.avatar %}
            <img src="{{ t.avatar.url }}" alt="{{ t.user.username }}"
                class="w-full h-full rounded-full object-cover border-2 border-amber-500">
          {% else %}
            <div class="w-full h-full rounded-full bg-gray-700 flex items-center justify-center border-2 border-amber-500">
              <span class="text-xl font-bold text-white">{{ t.user.username|first|upper }}</span>
            </div>
          {% endif %}
          <div class="absolute -bottom-2 right-0">
            <span class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-bold bg-purple-600 text-purple-50">
              #{{ forloop.counter }}
            </span>
          </div>
        </div>

        <h3 class="font-semibold text-white text-sm truncate" title="{{ t.user.username }}">{{ t.user.username }}</h3>

        <div class="mt-2 flex items-center justify-center gap-3 text-[11px] text-gray-300">
          <span class="inline-flex items-center gap-1" title="Loyihalar soni">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M18 2H8a2 2 0 00-2 2v15a3 3 0 012-2.82V4h10v14h2V4a2 2 0 00-2-2zM6 6H4v14a2 2 0 002 2h10v-2H6V6z"/></svg>
            {{ t.manga_count|default:"0" }}
          </span>
          <span class="inline-flex items-center gap-1" title="Obunachilar">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zM8 11c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm8 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
            {{ t.follower_count|default:"0" }}
          </span>
          <span class="inline-flex items-center gap-1" title="Like/Thanks">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12.1 8.64l-.1.1-.11-.1C10.14 6.6 7.1 6.24 5.14 8.2c-2.07 2.07-1.48 5.44 1.06 7.32L12 21l5.8-5.48c2.54-1.88 3.13-5.25 1.06-7.32-1.96-1.96-5-1.6-6.76.44z"/></svg>
            {{ t.likes_count|default:"0" }}
          </span>
        </div>
      </a>
      {% endfor %}
    </div>
  </section>
  {% endcache %}

  {# ===================== Yaqinda qo‘shilganlar ===================== #}
  <section aria-labelledby="recent-title">
    <div class="flex items-center justify-between mb-3">
      <h2 id="recent-title" class="text-lg sm:text-xl font-semibold text-white tracking-tight">
        <span class="inline-flex items-center gap-2">
          Yaqinda qo‘shilganlar
        </span>
      </h2>
    </div>

    {# Desktop sarlavha qatori #}
    <div class="hidden md:grid md:grid-cols-12 px-3 py-2 border-b border-gray-800 text-gray-400 text-sm">
      <div class="col-span-5">Taytl</div>
      <div class="col-span-4 text-center"></div>
      <div class="col-span-3 text-right">Yangilangan vaqti</div>
    </div>

    <div class="flex flex-col divide-y divide-gray-800">
      {% for item in recent_feed %}
        {% with m=item.manga chs=item.chapters last=item.last total=item.total more=item.more %}
        {# ===================== Mobile (≤ md) kartochka ===================== #}
        <div class="md:hidden px-3 py-3">
          <div class="grid grid-cols-[72px,1fr] gap-3">
            <a href="{% url 'manga:manga_details' m.slug %}" class="col-span-1">
              <img src="{{ m.cover_image.url }}" alt="{{ m.title }}"
                  class="w-[72px] h-[100px] rounded-lg object-cover shadow" loading="lazy">
            </a>

            <div class="col-span-1 min-w-0">
              <div class="flex items-center justify-between text-[11px] text-gray-400 mb-1">
                <span class="truncate">{{ m.type }}</span>
                <span class="flex items-center gap-1 shrink-0">
                  <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 8V12l3 3 1-1-3-3V8z"/><path d="M12 2a10 10 0 100 20 10 10 0 000-20z"/>
                  </svg>
                  {{ item.ago }}
                </span>
              </div>

              <a href="{% url 'manga:manga_details' m.slug %}"
                class="block text-white font-semibold text-[15px] leading-snug line-clamp-2 hover:text-purple-400">
                {{ m.title }}
              </a>

              <div class="mt-2 flex flex-wrap gap-1.5">
                {% for c in chs %}
                  <a href="{% url 'manga:chapter_read' m.slug c.obj.volume c.obj.chapter_number %}"
                    class="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-gray-800/80 hover:bg-gray-700 text-[12px] text-purple-200">
                    <span>Bob {{ c.obj.chapter_number }}</span>
                  </a>
                {% endfor %}

                {% if more %}
                  <a href="{% url 'manga:manga_details' m.slug %}"
                    class="inline-flex items-center px-2 py-1 rounded-md text-[12px] text-gray-300">
                    Yana {{ more }}…
                  </a>
                {% elif total > chs|length %}
                  <a href="{% url 'manga:manga_details' m.slug %}"
                    class="inline-flex items-center px-2 py-1 rounded-md text-[12px] text-gray-300">
                    Yana boblar…
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        {# ===================== Desktop (md+) eski qatordagi dizayn ===================== #}
        <div class="hidden md:grid md:grid-cols-12 gap-3 px-3 py-4">
          <!-- Cover -->
          <a href="{% url 'manga:manga_details' m.slug %}" class="md:col-span-1">
            <img src="{{ m.cover_image.url }}" alt="{{ m.title }}"
                class="w-16 h-24 rounded-lg object-cover shadow" loading="lazy">
          </a>

          <!-- Chap blok -->
          <div class="md:col-span-4 min-w-0">
            <a href="{% url 'manga:manga_details' m.slug %}"
              class="block text-white font-semibold text-lg truncate hover:underline">
              {{ m.title }}
            </a>
            <div class="text-gray-400 text-sm mt-1">
              {{ total }} ta yangi bob
            </div>
          </div>

          <!-- O‘rta blok: oxirgi 3 bob -->
          <div class="md:col-span-5">
            <div class="w-full">
              {% for c in chs %}
                <div class="flex items-center py-1.5">
                  {% if c.translators %}
                    <div class="-space-x-2 flex flex-shrink-0">
                      {% for t in c.translators %}
                        {% if t.avatar %}
                          <img src="{{ t.avatar.url }}" class="w-6 h-6 rounded-full ring-1 ring-gray-900"
                              alt="{{ t.user.username }}" title="{{ t.user.username }}">
                        {% else %}
                          <div title="{{ t.user.username }}"
                              class="w-6 h-6 rounded-full ring-1 ring-gray-900 bg-gray-700 text-white text-[10px] flex items-center justify-center">
                            {{ t.user.username|first|upper }}
                          </div>
                        {% endif %}
                      {% endfor %}
                    </div>
                  {% else %}
                    <div class="w-6"></div>
                  {% endif %}

                  <a href="{% url 'manga:chapter_read' m.slug c.obj.volume c.obj.chapter_number %}"
                    class="ml-3 text-sm text-purple-200 hover:text-purple-100 truncate">
                    {% if c.obj.volume %}Jild {{ c.obj.volume }}.{% endif %} Bob {{ c.obj.chapter_number }}
                  </a>
                </div>
              {% endfor %}

              {% if more %}
                <div class="pt-1">
                  <a href="{% url 'manga:manga_details' m.slug %}"
                    class="ml-9 text-xs text-gray-400 hover:text-gray-200">
                    Yana {{ more }} bob…
                  </a>
                </div>
              {% elif total > chs|length %}
                <div class="pt-1">
                  <a href="{% url 'manga:manga_details' m.slug %}"
                    class="ml-9 text-xs text-gray-400 hover:text-gray-200">
                    Yana boblar…
                  </a>
                </div>
              {% endif %}
            </div>
          </div>

          <!-- O‘ng blok: vaqt -->
          <div class="md:col-span-2 flex items-start justify-end">
            <div class="text-gray-400 text-sm flex items-center gap-1">
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 8V12l3 3 1-1-3-3V8z"/>
                <path d="M12 2a10 10 0 100 20 10 10 0 000-20zM12 20a8 8 0 110-16 8 8 0 010 16z"/>
              </svg>
              {{ item.ago }}
            </div>
          </div>
        </div>
        {% endwith %}
      {% empty %}
        <div class="px-3 py-6 text-gray-400">Hozircha yangilanish yo‘q.</div>
      {% endfor %}
    </div>
  </section>
</div>

<script>
  (function () {
    // Bitta karuselni ulash
    function wire(base) {
      const row  = document.getElementById(base + 'Row');
      const prev = document.getElementById(base + 'Prev');
      const next = document.getElementById(base + 'Next');
      if (!row || !prev || !next) return;

      const update = () => {
        const max = Math.max(0, row.scrollWidth - row.clientWidth - 1);
        prev.disabled = row.scrollLeft <= 0;
        next.disabled = row.scrollLeft >= max;
      };

      const scrollByPage = (dir) =>
        row.scrollBy({ left: dir * row.clientWidth, behavior: 'smooth' });

      prev.addEventListener('click', () => scrollByPage(-1));
      next.addEventListener('click', () => scrollByPage(1));

      // Performance uchun passiv listener
      row.addEventListener('scroll', update, { passive: true });
      window.addEventListener('resize', update);

      // Ba’zi brauzerlarda scroll tugaganini ushlash (agar bo‘lsa)
      row.addEventListener?.('scrollend', update);

      // Dastlabki holat
      requestAnimationFrame(update);
    }

    // ID nomlash sharti: <prefix>Row / <prefix>Prev / <prefix>Next
    // Masalan: trendingRow, trendingPrev, trendingNext
    const bases = new Set(
      Array.from(
        document.querySelectorAll('button.navbtn[id$="Prev"], button.navbtn[id$="Next"]')
      ).map(btn => btn.id.replace(/(Prev|Next)$/, ''))
    );

    bases.forEach(wire);
  })();
</script>

{% endblock %}
