{# templates/manga/history.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}O'qish tarixi - MangaLab{% endblock %}

{% block content %}
<style>[x-cloak]{display:none}</style>

<div x-data="{ clearOpen:false }" class="mx-auto max-w-7xl px-3 sm:px-6 lg:px-16 py-6 md:py-8">

  {# ==== Toast messages ==== #}
  {% if messages %}
  <div class="fixed z-30 top-3 right-3 space-y-2">
    {% for m in messages %}
      <div class="px-4 py-2 rounded-lg bg-white/10 border border-white/10 backdrop-blur text-sm">
        {{ m }}
      </div>
    {% endfor %}
  </div>
  {% endif %}

  {# ====== MOBILE top bar (tabs + clear) ====== #}
  <div class="md:hidden mb-3">
    <div class="flex items-center justify-between gap-2">
      <h2 class="text-lg font-semibold">Tarix</h2>
      <button type="button"
              @click="clearOpen=true"
              class="inline-flex items-center gap-1.5 px-3 h-9 rounded-md bg-white/5 hover:bg-white/10 text-sm">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M7 12h10M10 18h7"/></svg>
        Tozalash
      </button>
    </div>

    <div class="mt-3 flex items-center gap-2 overflow-x-auto no-scrollbar">
      <a href="{% url 'manga:history' %}?tab=titles&order={{ order }}&q={{ q|urlencode }}"
         class="flex items-center gap-1.5 px-3 py-2 rounded-lg {% if tab == 'titles' %}bg-white/10{% else %}bg-white/5{% endif %} text-sm shrink-0">
        <span>Taytlar</span>
        <span class="inline-flex items-center justify-center min-w-[22px] h-5 px-1 rounded bg-white/10 text-xs font-bold">{{ counts.titles|default:0 }}</span>
      </a>
      <a href="{% url 'manga:history' %}?tab=translators&order={{ order }}&q={{ q|urlencode }}"
         class="flex items-center gap-1.5 px-3 py-2 rounded-lg {% if tab == 'translators' %}bg-white/10{% else %}bg-white/5{% endif %} text-sm shrink-0">
        <span>Tarjimonlar</span>
        <span class="inline-flex items-center justify-center min-w-[22px] h-5 px-1 rounded bg-white/10 text-xs font-bold">{{ counts.translators|default:0 }}</span>
      </a>
      <a href="{% url 'manga:history' %}?tab=authors&order={{ order }}&q={{ q|urlencode }}"
         class="flex items-center gap-1.5 px-3 py-2 rounded-lg {% if tab == 'authors' %}bg-white/10{% else %}bg-white/5{% endif %} text-sm shrink-0">
        <span>Avtorlar</span>
        <span class="inline-flex items-center justify-center min-w-[22px] h-5 px-1 rounded bg-white/10 text-xs font-bold">{{ counts.authors|default:0 }}</span>
      </a>
      <a href="{% url 'manga:history' %}?tab=publishers&order={{ order }}&q={{ q|urlencode }}"
         class="flex items-center gap-1.5 px-3 py-2 rounded-lg {% if tab == 'publishers' %}bg-white/10{% else %}bg-white/5{% endif %} text-sm shrink-0">
        <span>Nashriyotlar</span>
        <span class="inline-flex items-center justify-center min-w-[22px] h-5 px-1 rounded bg-white/10 text-xs font-bold">{{ counts.publishers|default:0 }}</span>
      </a>
      <a href="{% url 'manga:history' %}?tab=collections&order={{ order }}&q={{ q|urlencode }}"
         class="flex items-center gap-1.5 px-3 py-2 rounded-lg {% if tab == 'collections' %}bg-white/10{% else %}bg-white/5{% endif %} text-sm shrink-0">
        <span>Kolleksiyalar</span>
        <span class="inline-flex items-center justify-center min-w-[22px] h-5 px-1 rounded bg-white/10 text-xs font-bold">{{ counts.collections|default:0 }}</span>
      </a>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
    {# ====== LEFT (desktop) ====== #}
    <aside class="hidden md:block md:col-span-4 lg:col-span-3">
      <div class="rounded-2xl border border-white/10 bg-[#162233] p-4">
        <h3 class="font-semibold text-lg mb-3">Bo'lim</h3>

        <div class="space-y-2">
          <a href="{% url 'manga:history' %}?tab=titles&order={{ order }}&q={{ q|urlencode }}"
             class="flex items-center justify-between px-3 py-2 rounded-lg {% if tab == 'titles' %}bg-white/10{% else %}bg-white/5{% endif %}">
            <span>Taytlar</span>
            <span class="inline-flex items-center justify-center min-w-[28px] h-7 px-2 rounded-md bg-white/10 text-sm font-bold">{{ counts.titles|default:0 }}</span>
          </a>
          <a href="{% url 'manga:history' %}?tab=translators&order={{ order }}&q={{ q|urlencode }}"
             class="flex items-center justify-between px-3 py-2 rounded-lg {% if tab == 'translators' %}bg-white/10{% else %}bg-white/5{% endif %}">
            <span>Tarjimonlar</span>
            <span class="inline-flex items-center justify-center min-w-[28px] h-7 px-2 rounded-md bg-white/10 text-sm font-bold">{{ counts.translators|default:0 }}</span>
          </a>
          <a href="{% url 'manga:history' %}?tab=authors&order={{ order }}&q={{ q|urlencode }}"
             class="flex items-center justify-between px-3 py-2 rounded-lg {% if tab == 'authors' %}bg-white/10{% else %}bg-white/5{% endif %}">
            <span>Avtorlar</span>
            <span class="inline-flex items-center justify-center min-w-[28px] h-7 px-2 rounded-md bg-white/10 text-sm font-bold">{{ counts.authors|default:0 }}</span>
          </a>
          <a href="{% url 'manga:history' %}?tab=publishers&order={{ order }}&q={{ q|urlencode }}"
             class="flex items-center justify-between px-3 py-2 rounded-lg {% if tab == 'publishers' %}bg-white/10{% else %}bg-white/5{% endif %}">
            <span>Nashriyotlar</span>
            <span class="inline-flex items-center justify-center min-w-[28px] h-7 px-2 rounded-md bg-white/10 text-sm font-bold">{{ counts.publishers|default:0 }}</span>
          </a>
          <a href="{% url 'manga:history' %}?tab=collections&order={{ order }}&q={{ q|urlencode }}"
             class="flex items-center justify-between px-3 py-2 rounded-lg {% if tab == 'collections' %}bg-white/10{% else %}bg-white/5{% endif %}">
            <span>Kolleksiyalar</span>
            <span class="inline-flex items-center justify-center min-w-[28px] h-7 px-2 rounded-md bg-white/10 text-sm font-bold">{{ counts.collections|default:0 }}</span>
          </a>
        </div>

        <h3 class="font-semibold text-lg mt-6 mb-3">Saralash</h3>
        <form method="get" class="space-y-2">
          <input type="hidden" name="q" value="{{ q }}">
          <input type="hidden" name="tab" value="{{ tab }}">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="radio" name="order" value="new" {% if order != 'old' %}checked{% endif %} class="accent-purple-500">
            <span>Avval yangilari</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="radio" name="order" value="old" {% if order == 'old' %}checked{% endif %} class="accent-purple-500">
            <span>Avval eskilari</span>
          </label>
          <button class="mt-2 w-full h-10 rounded-lg bg-white/10 hover:bg-white/15">Qo‘llash</button>
        </form>
      </div>
    </aside>

    {# ====== RIGHT: list ====== #}
    <section class="md:col-span-8 lg:col-span-9">
      <div class="rounded-2xl border border-white/10 bg-[#162233]">
        <div class="flex items-center justify-between gap-3 p-4 border-b border-white/10">
          <h2 class="text-xl font-semibold hidden md:block">Tarix</h2>
          <form method="get" class="flex-1 max-w-xl">
            <div class="relative">
              <input type="hidden" name="order" value="{{ order }}">
              <input type="hidden" name="tab" value="{{ tab }}">
              <input name="q" value="{{ q }}" placeholder="Qidiruv…"
                     class="w-full h-11 rounded-lg bg-white/5 pl-10 pr-3 outline-none placeholder:text-slate-400">
              <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 opacity-70" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
              </svg>
            </div>
          </form>
          <button type="button" @click="clearOpen=true"
                  class="hidden md:inline-flex px-3 h-10 items-center gap-2 rounded-lg bg-white/5 hover:bg-white/10">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M7 12h10M10 18h7"/></svg>
            Tozalash
          </button>
        </div>

        {% if items %}
          <ul class="divide-y divide-white/5">
            {% if tab == 'titles' %}
              {% for it in items %}
                {% with m=it.manga ch=it.last_chapter %}
                <li class="p-4 md:p-5">
                  <div class="flex items-start gap-4">
                    <a href="{% url 'manga:manga_details' m.slug %}" class="shrink-0">
                      {% if m.cover_image %}
                        <img src="{{ m.cover_image.url }}" alt="{{ m.title }}" class="w-20 h-28 object-cover rounded-lg border border-white/10">
                      {% else %}
                        <div class="w-20 h-28 rounded-lg border border-white/10 bg-white/5 grid place-items-center">
                          <svg class="w-8 h-8 opacity-70" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18"/><path d="m3 16 5-5 4 4 5-6 4 5"/></svg>
                        </div>
                      {% endif %}
                    </a>

                    <div class="min-w-0 flex-1">
                      <a href="{% url 'manga:manga_details' m.slug %}" class="block font-semibold text-base md:text-lg hover:text-purple-400 truncate">
                        {{ m.title }}{% if it.alt_name %}<span class="opacity-80">/ {{ it.alt_name }}</span>{% endif %}
                      </a>

                      <div class="text-slate-400 text-sm mt-1">
                        Ko‘rildi {{ it.ago }}
                        {% if ch %}
                          · Bob: {{ ch.chapter_number }}{% if it.chap_total %}/{{ it.chap_total }}{% endif %}
                          {% if it.page and it.page > 1 %} · {{ it.page }}-sahifa{% endif %}
                        {% endif %}
                      </div>

                      {% if it.resume_url %}
                        <div class="mt-3">
                          <a href="{{ it.resume_url }}" class="inline-flex items-center gap-2 px-3 h-9 rounded-lg bg-purple-600 hover:bg-purple-500 text-sm">
                            Davom ettirish
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
                          </a>
                        </div>
                      {% endif %}
                    </div>

                    {# three-dots #}
                    <div x-data="{open:false}" class="relative">
                      <button type="button" @click="open=!open" @keydown.escape.window="open=false"
                              class="shrink-0 p-2 rounded hover:bg-white/10" aria-label="More">
                        <svg class="w-6 h-6 opacity-80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="5" cy="12" r="1"/><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/>
                        </svg>
                      </button>
                      <div x-cloak x-show="open" x-transition @click.outside="open=false"
                           class="absolute z-20 right-0 top-10 w-44 rounded-xl border border-white/10 bg-[#0f1b2d] shadow-xl overflow-hidden">
                        <form method="post" action="{% url 'manga:history_remove' m.id %}">
                          {% csrf_token %}
                          <input type="hidden" name="next" value="{{ request.get_full_path }}">
                          <button type="submit" class="w-full text-left px-4 py-2 hover:bg-white/5">O‘chirish</button>
                        </form>
                        <a href="{% url 'manga:manga_details' m.slug %}" class="block px-4 py-2 hover:bg-white/5">O‘tish</a>
                      </div>
                    </div>
                  </div>
                </li>
                {% endwith %}
              {% endfor %}
            {% elif tab == 'translators' %}
              {% for it in items %}
                {% with prof=it.profile|default:it %}
                <li class="p-4 md:p-5">
                  <div class="flex items-start gap-4">
                    <div class="shrink-0">
                      {% if prof.avatar %}
                        <img src="{{ prof.avatar.url }}" class="w-14 h-14 rounded-full border border-white/10" alt="">
                      {% else %}
                        <div class="w-14 h-14 rounded-full bg-white/10 grid place-items-center">
                          <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21a8 8 0 1 0-16 0"/><circle cx="12" cy="8" r="4"/></svg>
                        </div>
                      {% endif %}
                    </div>
                    <div class="min-w-0 flex-1">
                      <div class="font-semibold text-base md:text-lg truncate">{{ prof.user.username }}</div>
                      <div class="text-slate-400 text-sm mt-1">Oxirgi faollik: {{ it.ago|default:"" }}</div>
                      {% if prof.description %}<p class="text-slate-300 text-sm mt-2 line-clamp-2">{{ prof.description }}</p>{% endif %}
                    </div>
                  </div>
                </li>
                {% endwith %}
              {% endfor %}
            {% else %}
              {% for it in items %}
              <li class="p-4 md:p-5">
                <div class="flex items-start gap-4">
                  <div class="w-16 h-16 rounded-lg bg-white/10 border border-white/10 grid place-items-center shrink-0">
                    <svg class="w-7 h-7 opacity-80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="9"/><path d="M8 12h8M12 8v8"/>
                    </svg>
                  </div>
                  <div class="min-w-0 flex-1">
                    <div class="font-semibold text-base md:text-lg truncate">{{ it.title|default:it.name|default:"—" }}</div>
                    <div class="text-slate-400 text-sm mt-1">Yangilandi {{ it.ago|default:"" }}</div>
                  </div>
                </div>
              </li>
              {% endfor %}
            {% endif %}
          </ul>

          {# ==== PAGINATION ==== #}
          {% if page_obj and page_obj.paginator.num_pages > 1 %}
          <div class="px-4 py-4 border-t border-white/10 flex items-center justify-center gap-1">
            {% if page_obj.has_previous %}
              <a class="px-3 py-2 rounded-lg hover:bg-white/10"
                 href="?{% if preserve_qs %}{{ preserve_qs }}&{% endif %}page={{ page_obj.previous_page_number }}">Oldingi</a>
            {% endif %}
            {% for n in elided_page_range %}
              {% if n == '…' %}
                <span class="px-3 py-2 opacity-70">…</span>
              {% elif n == page_obj.number %}
                <span class="px-3 py-2 rounded-lg bg-white/10 font-semibold">{{ n }}</span>
              {% else %}
                <a class="px-3 py-2 rounded-lg hover:bg-white/10"
                   href="?{% if preserve_qs %}{{ preserve_qs }}&{% endif %}page={{ n }}">{{ n }}</a>
              {% endif %}
            {% endfor %}
            {% if page_obj.has_next %}
              <a class="px-3 py-2 rounded-lg hover:bg-white/10"
                 href="?{% if preserve_qs %}{{ preserve_qs }}&{% endif %}page={{ page_obj.next_page_number }}">Keyingi</a>
            {% endif %}
          </div>
          {% endif %}
        {% else %}
          <div class="p-8 text-center text-slate-300">Hozircha tarix bo‘sh.</div>
        {% endif %}
      </div>
    </section>
  </div>

  {# ====== CLEAR MODAL ====== #}
  <div x-cloak x-show="clearOpen" class="fixed inset-0 z-40 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/60" @click="clearOpen=false"></div>
    <div class="relative w-full max-w-lg rounded-2xl bg-[#0f1b2d] border border-white/10 shadow-xl">
      <div class="flex items-center justify-between px-5 py-4 border-b border-white/10">
        <h3 class="text-lg font-semibold">Tarixni tozalash</h3>
        <button class="p-2 hover:bg-white/10 rounded-lg" @click="clearOpen=false">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>
        </button>
      </div>
      <form method="post" action="{% url 'manga:history_clear' %}">
        {% csrf_token %}
        <input type="hidden" name="tab" value="{{ tab }}">
        <input type="hidden" name="next" value="{{ request.get_full_path }}">
        <div class="p-5 space-y-4">
          <p>Joriy bo'limdagi tarixni tozalashni xohlaysizmi?</p>
          <label class="flex items-center gap-3">
            <input type="checkbox" name="all" value="1" class="accent-purple-500">
            <span>Barcha bo'limlarni tozalash</span>
          </label>
        </div>
        <div class="px-5 py-4 border-t border-white/10 flex items-center justify-end gap-3">
          <button type="button" @click="clearOpen=false" class="h-10 px-4 rounded-lg bg-white/10 hover:bg-white/15">Bekor qilish</button>
          <button type="submit" class="h-10 px-4 rounded-lg bg-red-600 hover:bg-red-500">Tozalash</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
