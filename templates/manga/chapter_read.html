{% load static %}
<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="{% static 'images/logo.png' %}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ chapter.manga.title }} — Bob {{ chapter.chapter_number }}</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js (dropdown uchun) -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>[x-cloak]{display:none!important}</style>
  <!-- Font Awesome -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
</head>

<body class="bg-[#0F0F1E] text-gray-100">

  <!-- ======== Sticky Navbar ======== -->
  <div id="navbar" class="sticky top-0 z-50 transform transition-transform duration-700 ease-in-out bg-gradient-to-b from-[#1A1A2E] to-[#1A1A2E]/90 backdrop-blur-sm">
    <div class="max-w-6xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between">

        <!-- Back -->
        <a href="{% url 'manga:manga_details' chapter.manga.slug %}"
           class="group inline-flex items-center gap-2 text-purple-300 hover:text-purple-200">
          <i class="fas fa-arrow-left"></i>
        </a>

        <!-- Chapter selector -->
        <div x-data="{open:false}" class="relative">
          <button @click="open=!open"
                  class="flex items-center gap-3 px-4 py-2 bg-purple-900 rounded-lg hover:bg-purple-800">
            <span class="font-semibold">Jild {{ chapter.volume }} • Bob {{ chapter.chapter_number }}</span>
            <i class="fas fa-chevron-down text-purple-300 transition-transform"
               :class="{'rotate-180':open}"></i>
          </button>

          <!-- Dropdown list -->
          <div x-show="open" x-cloak @click.away="open=false"
               class="absolute right-0 mt-2 w-80 max-h-[60vh] overflow-y-auto
                      bg-[#1A1A2E] rounded-xl shadow-2xl
                      scrollbar-thin scrollbar-thumb-purple-900/50 scrollbar-track-[#0F0F1E]">
            <ul class="divide-y divide-purple-800/50">
              {% for ch in all_chapters %}
                {% comment %}
                  LOCK holati: pullik + O‘QIB BO‘LMAYDIGAN bob (readable_chapter_ids ichida yo‘q)
                {% endcomment %}
                {% if ch.price_tanga > 0 and request.user.is_authenticated and ch.id not in readable_chapter_ids %}
                  <li>
                    <button type="button"
                            class="js-open-purchase group flex items-center w-full text-left px-5 py-3.5 hover:bg-purple-900/20 transition"
                            data-vol="{{ ch.volume }}"
                            data-ch="{{ ch.chapter_number }}"
                            data-price="{{ ch.price_tanga }}">
                      <div class="flex items-center gap-3 min-w-0 flex-1">
                        <i class="fas fa-lock text-yellow-400 w-5 text-center"></i>
                        <div class="min-w-0 flex-1">
                          <div class="flex items-baseline justify-between gap-2">
                            <p class="text-sm truncate text-purple-200">Jild {{ ch.volume }} • Bob {{ ch.chapter_number }}</p>
                            <span class="text-xs text-purple-500">{{ ch.release_date|date:"d.m.Y" }}</span>
                          </div>
                        </div>
                      </div>
                    </button>
                  </li>
                {% else %}
                  <li>
                    <a href="{% url 'manga:chapter_read' manga.slug ch.volume ch.chapter_number %}"
                       class="group flex items-center px-5 py-3.5 hover:bg-purple-900/20 transition">
                      <div class="flex items-center gap-3 min-w-0 flex-1">
                        <span class="w-5 text-center">
                          {% if reading_progress and reading_progress.last_read_chapter %}
                            {% if ch.id == reading_progress.last_read_chapter.id %}
                              <i class="fas fa-bookmark text-amber-400 rotate-12"></i>
                            {% elif ch.id in user_read_chapters %}
                              <i class="fas fa-check-circle text-emerald-400"></i>
                            {% endif %}
                          {% endif %}
                        </span>
                        <div class="min-w-0 flex-1">
                          <div class="flex items-baseline justify-between gap-2">
                            <p class="text-sm truncate text-purple-200">Jild {{ ch.volume }} • Bob {{ ch.chapter_number }}</p>
                            <span class="text-xs text-purple-500">{{ ch.release_date|date:"d.m.Y" }}</span>
                          </div>
                        </div>
                      </div>
                    </a>
                  </li>
                {% endif %}
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ======== Pages (images) ======== -->
  {% include "manga/includes/_chapter_pages.html" %}

  <!-- ======== Thank button ======== -->
  <div class="mt-4 text-center">
    {% if user.is_authenticated %}
      <button id="thankBtn"
              class="inline-flex items-center px-6 py-3 gap-3 bg-purple-900 rounded-full hover:bg-purple-800 transition"
              data-chapter-id="{{ chapter.id }}">
        <i class="fas fa-heart {% if user in chapter.thanks.all %}text-red-400{% else %}text-red-300/70{% endif %}"></i>
        <span id="thankText" class="font-medium">
          {% if user in chapter.thanks.all %}Rahmat aytildi{% else %}Rahmat aytish{% endif %}
        </span>
        <span id="thankCount" class="text-purple-300/70 text-sm">({{ chapter.thanks_count }})</span>
      </button>
    {% else %}
      <p class="text-purple-300/80 bg-purple-900/20 p-4 rounded-lg inline-flex items-center gap-2">
        <i class="fas fa-info-circle text-purple-400"></i>
        <a href="{% url 'accounts:login' %}" class="text-purple-400 hover:text-purple-300">Kiring rahmat aytish uchun</a>
      </p>
    {% endif %}
  </div>

  <!-- ======== Bottom navigation (prev/next) ======== -->
  <div class="max-w-6xl mx-auto px-4 py-6 flex justify-center items-center gap-4">

    {% if previous_chapter %}
      <a href="{% url 'manga:chapter_read' manga.slug previous_chapter.volume previous_chapter.chapter_number %}"
         class="flex items-center gap-3 px-5 py-3 bg-purple-600 rounded-xl border border-purple-900 hover:bg-purple-900 transition">
        <i class="fas fa-arrow-left text-indigo-200"></i>
        <span class="text-indigo-100 font-medium">Bob {{ previous_chapter.chapter_number }}</span>
      </a>
    {% else %}
      <a href="{% url 'manga:manga_details' chapter.manga.slug %}"
         class="flex items-center gap-3 px-5 py-3 bg-gradient-to-r from-gray-800 to-gray-900 rounded-xl border border-purple-500/30 hover:border-purple-400/50 transition">
        <i class="fas fa-book-open text-purple-400"></i>
        <span class="text-purple-300 font-medium">Manga sahifasiga</span>
      </a>
    {% endif %}

    {% if next_chapter %}
      {% if next_chapter_price and manga.created_by != request.user %}
        <button type="button"
                class="js-open-purchase flex items-center gap-3 px-5 py-3 bg-indigo-600 rounded-xl border border-indigo-800 hover:bg-indigo-800 transition"
                data-vol="{{ next_chapter.volume }}"
                data-ch="{{ next_chapter.chapter_number }}"
                data-price="{{ next_chapter_price }}">
          <span class="text-white font-medium">Bob {{ next_chapter.chapter_number }} ({{ next_chapter_price }} tanga)</span>
          <i class="fas fa-lock text-yellow-400"></i>
        </button>
      {% else %}
        <a href="{% url 'manga:chapter_read' manga.slug next_chapter.volume next_chapter.chapter_number %}"
           class="flex items-center gap-3 px-5 py-3 bg-purple-600 rounded-xl border border-purple-900 hover:bg-purple-900 transition">
          <span class="text-indigo-100 font-medium">Bob {{ next_chapter.chapter_number }}</span>
          <i class="fas fa-arrow-right text-indigo-200"></i>
        </a>
      {% endif %}
    {% else %}
      <div class="flex items-center gap-3 px-5 py-3 bg-gradient-to-l from-gray-800 to-gray-900 rounded-xl border border-purple-500/30 opacity-70">
        <span class="text-purple-300 font-medium">Oxirgi bob</span>
        <i class="fas fa-trophy text-yellow-400/70"></i>
      </div>
    {% endif %}
  </div>

  {% if is_last_chapter %}
    <div class="max-w-6xl mx-auto px-4">
      <div class="text-center py-4 bg-purple-900/20 rounded-lg">
        <p class="text-purple-300">Bu manga uchun oxirgi bob!</p>
      </div>
    </div>
  {% endif %}

  <!-- ======== Universal Purchase Modal (JS orqali to‘ldiriladi) ======== -->
  <div id="buyModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-8 text-center max-w-md w-full 
                border border-purple-500/30 shadow-2xl shadow-purple-500/10">
      <div class="mb-6 flex justify-center">
        <div class="bg-yellow-500/20 p-4 rounded-full border border-yellow-500/40">
          <i class="fas fa-crown text-3xl text-yellow-400"></i>
        </div>
      </div>
      <h2 class="text-2xl font-bold text-yellow-400 mb-3">Premium Bob</h2>
      <p class="text-gray-300 mb-6 leading-relaxed">
        "<span id="modalTitle" class="text-white font-medium"></span>" mangasining
        <span id="modalChapter" class="text-yellow-300"></span>-bobi pullik kontent hisoblanadi.
      </p>
      <div class="bg-gray-700/50 rounded-lg p-4 mb-6 border border-gray-600/50">
        <p class="text-gray-200 text-lg">Narx:
          <span id="modalPrice" class="text-purple-400 font-bold">0</span> tanga
        </p>
      </div>
      <div class="flex justify-center gap-3">
        <button id="buyBtn"
                class="px-6 py-3 rounded-xl bg-purple-600 hover:bg-purple-700 transition flex items-center gap-2">
          <i class="fas fa-shopping-cart"></i><span>Sotib olish</span>
        </button>
        <button id="closeBuyModal"
                class="px-6 py-3 rounded-xl bg-gray-600 hover:bg-gray-700 transition text-white flex items-center gap-2">
          <i class="fas fa-times"></i><span>Bekor qilish</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ======== Scripts ======== -->
  <script>
    // Navbar autohide (desktop)
    (function(){
      const nav = document.getElementById('navbar');
      const navH = nav.offsetHeight;
      let last = window.pageYOffset || document.documentElement.scrollTop;
      let ticking = false;

      window.addEventListener('scroll', () => {
        if (window.innerWidth < 768) return;
        if (ticking) return;
        ticking = true;
        requestAnimationFrame(() => {
          const cur = window.pageYOffset || document.documentElement.scrollTop;
          const d = cur - last;
          if (Math.abs(d) > 5) {
            if (d > 0 && cur > navH) nav.classList.add('-translate-y-full');
            else if (d < 0) nav.classList.remove('-translate-y-full');
            last = cur;
          }
          ticking = false;
        });
      }, {passive:true});
    })();
  </script>

  <script>
    // -------- Purchase modal helpers --------
    const mangaTitle = "{{ manga.title|escapejs }}";
    const BUY_URL_TPL  = "{% url 'manga:purchase_chapter' manga.slug 111 222 %}";
    const READ_URL_TPL = "{% url 'manga:chapter_read'    manga.slug 111 222 %}";

    const buyModal   = document.getElementById('buyModal');
    const buyBtn     = document.getElementById('buyBtn');
    const closeModal = document.getElementById('closeBuyModal');
    const modalTitle   = document.getElementById('modalTitle');
    const modalChapter = document.getElementById('modalChapter');
    const modalPrice   = document.getElementById('modalPrice');

    let targetBuyUrl = "";
    let targetReadUrl = "";

    function buildUrl(tpl, vol, ch) {
      return tpl.replace('/111/', '/' + vol + '/').replace('/222/', '/' + ch + '/');
    }

    function openPurchase(vol, ch, price) {
      modalTitle.textContent   = mangaTitle;
      modalChapter.textContent = ch;
      modalPrice.textContent   = price;
      targetBuyUrl  = buildUrl(BUY_URL_TPL,  vol, ch);
      targetReadUrl = buildUrl(READ_URL_TPL, vol, ch);
      buyModal.classList.remove('hidden');
    }

    // Delegation: har qanday .js-open-purchase tugmasi
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.js-open-purchase');
      if (!btn) return;
      openPurchase(btn.dataset.vol, btn.dataset.ch, btn.dataset.price);
    });

    closeModal.addEventListener('click', () => buyModal.classList.add('hidden'));
    buyModal.addEventListener('click', (e) => { if (e.target === buyModal) buyModal.classList.add('hidden'); });

    buyBtn.addEventListener('click', async function(){
      const self = this;
      self.disabled = true;
      const oldHTML = self.innerHTML;
      self.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Jarayonda…</span>';
      try{
        const res  = await fetch(targetBuyUrl, {
          method: 'POST',
          headers: {'X-CSRFToken': '{{ csrf_token }}', 'X-Requested-With': 'XMLHttpRequest'}
        });
        const data = await res.json();
        if (data.success) {
          self.innerHTML = '<i class="fas fa-check"></i> <span>Muvaffaqiyatli!</span>';
          setTimeout(()=>{ window.location.href = targetReadUrl; }, 700);
        } else {
          self.innerHTML = oldHTML;
          alert(data.message || 'Xatolik yuz berdi, qayta urinib ko‘ring.');
          self.disabled = false;
        }
      } catch(err){
        console.error(err);
        self.innerHTML = oldHTML;
        alert('Tarmoq xatosi. Internet aloqasini tekshiring.');
        self.disabled = false;
      }
    });
  </script>

  <script>
    // -------- Thank toggle --------
    document.getElementById('thankBtn')?.addEventListener('click', async function(){
      const btn = this;
      const id  = btn.dataset.chapterId;
      const url = `{% url 'manga:thank_chapter' 0 %}`.replace('/0/', `/${id}/`);

      try{
        const res = await fetch(url, {
          method:'POST',
          headers:{'X-CSRFToken':'{{ csrf_token }}','X-Requested-With':'XMLHttpRequest'}
        });
        const {thanked, count} = await res.json();
        const icon   = btn.querySelector('.fa-heart');
        const textEl = btn.querySelector('#thankText');
        const cntEl  = btn.querySelector('#thankCount');

        icon.classList.toggle('text-red-400', thanked);
        textEl.textContent = thanked ? 'Rahmat aytildi' : 'Rahmat aytish';
        cntEl.textContent  = `(${count})`;
      }catch(err){
        console.error('Thank error:', err);
      }
    });
  </script>

<script>
  (function () {
    const nav = document.getElementById('navbar');
    const HIDE = '-translate-y-full';
    const isMobile = () =>
      window.matchMedia('(max-width: 767px)').matches || navigator.maxTouchPoints > 0;

    // mobilga kirganda — yashirin; desktopga o‘tganda — ko‘rinadigan holatni saqlaymiz
    function syncState() {
      if (isMobile()) nav.classList.add(HIDE);
      else nav.classList.remove(HIDE);
    }
    syncState();
    window.addEventListener('resize', syncState);

    // ⛔ Hech qanday scroll listener yo‘q mobil uchun (faqat tap ishlaydi)

    // Tap aniqlash (kaltagina bosish)
    let sx = 0, sy = 0, st = 0;
    document.addEventListener('touchstart', (e) => {
      if (!isMobile()) return;
      const t = e.changedTouches[0];
      sx = t.clientX; sy = t.clientY; st = Date.now();
    }, { passive: true });

    document.addEventListener('touchend', (e) => {
      if (!isMobile()) return;

      const t = e.changedTouches[0];
      const dx = Math.abs(t.clientX - sx);
      const dy = Math.abs(t.clientY - sy);
      const dt = Date.now() - st;
      const isTap = dx < 6 && dy < 6 && dt < 300;

      if (!isTap) return;

      // modal ochiq bo‘lsa (sotib olish), navni o‘zgartirmaymiz
      const modal = document.getElementById('buyModal');
      if (modal && !modal.classList.contains('hidden')) return;

      const insideNav = e.target.closest('#navbar');

      // Tashqariga bosilsa: nav ko‘rinmasa — ko‘rsatamiz; ko‘rinib turgan bo‘lsa — yopamiz
      if (!insideNav) {
        nav.classList.toggle(HIDE);
        return;
      }

      // Nav ichida bosilsa: eventlar ishlasin, keyin ozgina kechikib yopamiz (qulaylik uchun)
      if (e.target.closest('a,button,select')) {
        setTimeout(() => nav.classList.add(HIDE), 250);
      }
    }, { passive: true });

    // Desktop xulqi (xohlasangiz qoldiring yoki olib tashlang)
    if (!isMobile()) {
      let last = window.pageYOffset || document.documentElement.scrollTop;
      let ticking = false;
      window.addEventListener('scroll', () => {
        if (isMobile()) return; // desktop-gina
        if (ticking) return;
        ticking = true;
        requestAnimationFrame(() => {
          const cur = window.pageYOffset || document.documentElement.scrollTop;
          const delta = cur - last;
          if (Math.abs(delta) > 5) {
            if (delta > 0 && cur > nav.offsetHeight) nav.classList.add(HIDE);
            else if (delta < 0) nav.classList.remove(HIDE);
            last = cur;
          }
          ticking = false;
        });
      }, { passive: true });
    }
  })();
</script>
</body>
</html>
