{% load static %}
<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="{% static 'images/logo.png' %}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ chapter.manga.title }} - Bob {{ chapter.chapter_number }}</title>

  <!-- Prefetch next chapter (agar bo'lsa) -->
  {% if next_chapter %}
    <link rel="prefetch" href="{% url 'manga:chapter_read' manga.slug next_chapter.volume next_chapter.chapter_number %}">
  {% else %}{% endif %}

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>

  <!-- Stil -->
  <style>
    :root { --page-w: 900px; } /* default eni */
    /* Reader konteyneri */
    .chapter-pages {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem; /* 16px */
      content-visibility: auto;
      contain-intrinsic-size: 0 2000px;
    }
    .chapter-pages img {
      width: var(--page-w);
      height: auto;
      display: block;
    }
    /* Panel blur */
    .reader-controls { backdrop-filter: blur(6px); }
    /* Animatsiyani kamaytirish */
    @media (prefers-reduced-motion: reduce) {
      #navbar { transition: none !important; }
      .slide-panel { transition: none !important; }
    }
  </style>
</head>

<body class="bg-[#0F0F1E] text-gray-100">

  <!-- ======== Sticky Navbar ======== -->
  <div id="navbar" class="sticky top-0 z-50 transform transition-transform duration-700 ease-in-out bg-gradient-to-b from-[#1A1A2E] to-[#1A1A2E]/90 backdrop-blur-sm">
    <div class="max-w-6xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between">

        <!-- Back -->
        <a href="{% url 'manga:manga_details' chapter.manga.slug %}"
           class="group inline-flex items-center gap-2 text-purple-300 hover:text-purple-200"
           aria-label="Manga sahifasiga qaytish">
          <i class="fas fa-arrow-left"></i>
        </a>

        <!-- Current chapter label -->
        <div class="flex items-center gap-3 text-purple-300">
          <span class="font-semibold">Jild {{ chapter.volume }} • Bob {{ chapter.chapter_number }}</span>
        </div>

        <!-- Sidebar toggle (Boblar) -->
        <button id="openChaps"
                class="flex items-center gap-2 px-4 py-2 bg-purple-900 rounded-lg hover:bg-purple-800"
                aria-controls="chapSidebar" aria-expanded="false">
          <i class="fas fa-list"></i>
          <span>Boblar</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ======== Chapters Sidebar (Slide-over) ======== -->
  <div id="chapSidebar" class="fixed inset-0 z-50 hidden" aria-hidden="true">
    {# Overlay ko‘rinmas – faqat click uchun transparent #}
    <div class="absolute inset-0 bg-transparent" id="chapMask"></div>

    <aside id="chapPanel"
           class="slide-panel absolute left-0 top-0 h-full w-[86%] sm:w-[420px]
                  bg-[#0F0F1E] border-r border-purple-500/30 shadow-2xl
                  translate-x-[-100%] transition-transform duration-300 will-change-transform"
           role="dialog" aria-labelledby="chapTitle">
      <div class="p-4 border-b border-purple-900/40 flex items-center justify-between gap-3">
        <h2 id="chapTitle" class="text-lg font-semibold text-purple-200">Boblar ro‘yxati</h2>

        <div class="flex items-center gap-2">
          <!-- 10 → 1 / 1 → 10 tartib filtri -->
          <div class="inline-flex rounded-lg bg-[#151526] border border-purple-500/40 text-xs overflow-hidden">
            <button id="chapSortDesc" type="button"
                    class="px-2.5 py-1 text-purple-300 hover:bg-purple-800 hover:text-white">
              10 → 1
            </button>
            <button id="chapSortAsc" type="button"
                    class="px-2.5 py-1 text-purple-300 hover:bg-purple-800 hover:text-white">
              1 → 10
            </button>
          </div>

          <button id="closeChaps" class="px-3 py-1.5 rounded-lg bg-gray-700 hover:bg-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <!-- Eslatma: Qidiruv olib tashlandi -->
      <div id="chapScroll"
          class="h-[calc(100%-72px)] overflow-y-auto scrollbar-thin
                  scrollbar-thumb-purple-900/50 scrollbar-track-[#0F0F1E]">
        <ul id="chapList" class="divide-y divide-purple-800/40">
          {% for ch in all_chapters %}
            <li class="group" {% if ch.id == chapter.id %}data-current="1"{% endif %}>
              {% if ch.price_tanga > 0 and ch.id not in readable_chapter_ids %}
                {# --- PREMIUM (LOCKED) --- #}
                <button type="button"
                        class="block w-full text-left px-4 py-3 flex items-center gap-3 hover:bg-purple-900/20
                              border-l-2 {% if ch.id == chapter.id %}bg-purple-900/40 border-purple-400 ring-1 ring-purple-400/10{% else %}border-transparent{% endif %}
                              js-open-purchase"
                        data-vol="{{ ch.volume }}"
                        data-ch="{{ ch.chapter_number }}"
                        data-price="{{ ch.price_tanga }}"
                        aria-label="Premium bob {{ ch.chapter_number }} sotib olish"
                        aria-current="{% if ch.id == chapter.id %}page{% else %}false{% endif %}">
                  <i class="fas fa-lock text-yellow-400 w-5 text-center" aria-hidden="true"></i>
                  <span class="flex-1 truncate">
                    Jild {{ ch.volume }} • Bob {{ ch.chapter_number }}
                    {% if ch.id == chapter.id %}<span class="sr-only">(Hozirgi bob)</span>{% endif %}
                  </span>
                  <span class="text-xs text-purple-500">{{ ch.release_date|date:"d.m.Y" }}</span>
                </button>
              {% else %}
                {# --- OCHIQ (FREE/READABLE) --- #}
                <a href="{% url 'manga:chapter_read' manga.slug ch.volume ch.chapter_number %}"
                  class="block w-full px-4 py-3 flex items-center gap-3 hover:bg-purple-900/20
                          border-l-2 {% if ch.id == chapter.id %}bg-purple-900/40 border-purple-400 ring-1 ring-purple-400/10{% else %}border-transparent{% endif %}"
                  aria-current="{% if ch.id == chapter.id %}page{% else %}false{% endif %}">
                  <span class="w-5 text-center">
                    {% if reading_progress and reading_progress.last_read_chapter %}
                      {% if ch.id == reading_progress.last_read_chapter.id %}
                        <i class="fas fa-bookmark text-amber-400 rotate-12" aria-hidden="true"></i>
                      {% else %}
                        {% if ch.id in user_read_chapters %}
                          <i class="fas fa-check-circle text-emerald-400" aria-hidden="true"></i>
                        {% else %}{% endif %}
                      {% endif %}
                    {% else %}{% endif %}
                  </span>
                  <span class="flex-1 truncate">
                    Jild {{ ch.volume }} • Bob {{ ch.chapter_number }}
                    {% if ch.id == chapter.id %}<span class="sr-only">(Hozirgi bob)</span>{% endif %}
                  </span>
                  <span class="text-xs text-purple-500">{{ ch.release_date|date:"d.m.Y" }}</span>
                </a>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    </aside>
  </div>

  <!-- ======== Pages (images) ======== -->
  <div id="reader" class="max-w-6xl mx-auto">
    <div class="chapter-pages" id="pageCol">
      {% include "manga/includes/_chapter_pages.html" %}
    </div>
  </div>

  <!-- ======== Thank button ======== -->
  <div class="mt-4 text-center">
    {% if user.is_authenticated %}
      <button id="thankBtn"
              class="inline-flex items-center px-6 py-3 gap-3 bg-purple-900 rounded-full hover:bg-purple-800 transition"
              data-chapter-id="{{ chapter.id }}">
        <i class="fas fa-heart {% if user in chapter.thanks.all %}text-red-400{% else %}text-red-300/70{% endif %}"></i>
        <span id="thankText" class="font-medium">
          {% if user in chapter.thanks.all %}Rahmat aytildi{% else %}Rahmat aytish{% endif %}
        </span>
        <span id="thankCount" class="text-purple-300/70 text-sm">({{ chapter.thanks_count }})</span>
      </button>
    {% else %}
      <p class="text-purple-300/80 bg-purple-900/20 p-4 rounded-lg inline-flex items-center gap-2">
        <i class="fas fa-info-circle text-purple-400"></i>
        <a href="{% url 'accounts:login' %}" class="text-purple-400 hover:text-purple-300">Kiring rahmat aytish uchun</a>
      </p>
    {% endif %}
  </div>

  <!-- ======== Bottom navigation (prev/next) ======== -->
  <div class="max-w-6xl mx-auto px-4 py-6 flex justify-center items-center gap-4">
    {% if previous_chapter %}
      <a data-prev-chap href="{% url 'manga:chapter_read' manga.slug previous_chapter.volume previous_chapter.chapter_number %}"
         class="flex items-center gap-3 px-5 py-3 bg-purple-600 rounded-xl border border-purple-900 hover:bg-purple-900 transition">
        <i class="fas fa-arrow-left text-indigo-200"></i>
        <span class="text-indigo-100 font-medium">Bob {{ previous_chapter.chapter_number }}</span>
      </a>
    {% else %}
      <a href="{% url 'manga:manga_details' chapter.manga.slug %}"
         class="flex items-center gap-3 px-5 py-3 bg-gradient-to-r from-gray-800 to-gray-900 rounded-xl border border-purple-500/30 hover:border-purple-400/50 transition">
        <i class="fas fa-book-open text-purple-400"></i>
        <span class="text-purple-300 font-medium">Manga sahifasiga</span>
      </a>
    {% endif %}

    {% if next_chapter %}
      {% if next_chapter_price and manga.created_by != request.user %}
        <button type="button"
                class="js-open-purchase flex items-center gap-3 px-5 py-3 bg-indigo-600 rounded-xl border border-indigo-800 hover:bg-indigo-800 transition"
                data-vol="{{ next_chapter.volume }}"
                data-ch="{{ next_chapter.chapter_number }}"
                data-price="{{ next_chapter_price }}">
          <span class="text-white font-medium">Bob {{ next_chapter.chapter_number }} ({{ next_chapter_price }} tanga)</span>
          <i class="fas fa-lock text-yellow-400"></i>
        </button>
      {% else %}
        <a data-next-chap href="{% url 'manga:chapter_read' manga.slug next_chapter.volume next_chapter.chapter_number %}"
           class="flex items-center gap-3 px-5 py-3 bg-purple-600 rounded-xl border border-purple-900 hover:bg-purple-900 transition">
          <span class="text-indigo-100 font-medium">Bob {{ next_chapter.chapter_number }}</span>
          <i class="fas fa-arrow-right text-indigo-200"></i>
        </a>
      {% endif %}
    {% else %}
      <div class="flex items-center gap-3 px-5 py-3 bg-gradient-to-l from-gray-800 to-gray-900 rounded-xl border border-purple-500/30 opacity-70">
        <span class="text-purple-300 font-medium">Oxirgi bob</span>
        <i class="fas fa-trophy text-yellow-400/70"></i>
      </div>
    {% endif %}
  </div>

  {% if is_last_chapter %}
    <div class="max-w-6xl mx-auto px-4">
      <div class="text-center py-4 bg-purple-900/20 rounded-lg">
        <p class="text-purple-300">Bu manga uchun oxirgi bob!</p>
      </div>
    </div>
  {% else %}{% endif %}

  <!-- ======== Universal Purchase Modal ======== -->
  <div id="buyModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4" role="dialog" aria-modal="true" aria-labelledby="buyModalTitle">
    <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-8 text-center max-w-md w-full 
                border border-purple-500/30 shadow-2xl shadow-purple-500/10">
      <div class="mb-6 flex justify-center">
        <div class="bg-yellow-500/20 p-4 rounded-full border border-yellow-500/40">
          <i class="fas fa-crown text-3xl text-yellow-400" aria-hidden="true"></i>
        </div>
      </div>
      <h2 id="buyModalTitle" class="text-2xl font-bold text-yellow-400 mb-3">Premium Bob</h2>
      <p class="text-gray-300 mb-6 leading-relaxed">
        "<span id="modalTitle" class="text-white font-medium"></span>" mangasining
        <span id="modalChapter" class="text-yellow-300"></span>-bobi pullik kontent hisoblanadi.
      </p>
      <div class="bg-gray-700/50 rounded-lg p-4 mb-6 border border-gray-600/50">
        <p class="text-gray-200 text-lg">Narx:
          <span id="modalPrice" class="text-purple-400 font-bold">0</span> tanga
        </p>
      </div>
      <div class="flex justify-center gap-3">
        <button id="buyBtn"
                class="px-6 py-3 rounded-xl bg-purple-600 hover:bg-purple-700 transition flex items-center gap-2">
          <i class="fas fa-shopping-cart"></i><span>Sotib olish</span>
        </button>
        <button id="closeBuyModal"
                class="px-6 py-3 rounded-xl bg-gray-600 hover:bg-gray-700 transition text-white flex items-center gap-2">
          <i class="fas fa-times"></i><span>Bekor qilish</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Toggle: telefonlarda ko‘rinmasin -->
  <button id="rcToggleBtn"
          class="hidden sm:flex fixed right-4 bottom-4 z-50 items-center gap-2 px-3 py-2
                rounded-xl bg-purple-900 hover:bg-purple-800 border border-purple-500/30 text-sm"
          aria-controls="rcPanel" aria-expanded="false">
    <i class="fas fa-sliders"></i>
    <span>O'qish moslamasi</span>
  </button>

  <!-- Panel (telefon: w-full; desktop: 280px) -->
  <div id="rcPanel"
      class="hidden fixed left-2 right-2 bottom-20 z-50 reader-controls
              bg-[#1A1A2E]/90 border border-purple-500/30 rounded-2xl p-3
              shadow-2xl shadow-purple-500/10 w-full md:w-[300px] md:left-auto md:right-4 select-none"
      role="dialog" aria-modal="true" aria-labelledby="rcTitle"
      data-rc-target="#pageCol">
    <div class="mb-2 flex items-center justify-between">
      <h3 id="rcTitle" class="text-sm font-semibold text-purple-200">O‘qish moslamasi</h3>
      <button id="rcClose" class="px-2 py-1 rounded-lg text-purple-300 hover:bg-purple-900" aria-label="Yopish">✕</button>
    </div>

    <!-- − / metr / ＋ / Reset -->
    <div class="flex items-center gap-3">
      <button id="rcMinus"
              class="px-3 py-2 rounded-lg bg-purple-900 hover:bg-purple-800 active:scale-95 transition"
              aria-label="Eni kamaytirish">−</button>

      <div class="flex-1">
        <div id="rcMeter"
            class="rc-meter h-8 flex items-end gap-1 px-1 rounded-lg bg-purple-950/60 border border-purple-500/20 overflow-hidden"
            role="slider" aria-label="Kenglik" aria-valuemin="480" aria-valuemax="1080" aria-valuenow="900"
            title="Bosib sudrang yoki g‘ildirakni aylantiring">
          <!-- JS 12 ta bar yaratadi -->
        </div>
        <div id="rcWidthOut" class="mt-1 text-center text-[11px] text-purple-300"></div>
      </div>

      <button id="rcPlus"
              class="px-3 py-2 rounded-lg bg-purple-900 hover:bg-purple-800 active:scale-95 transition"
              aria-label="Eni oshirish">+</button>

      <!-- RESET -->
      <button id="rcReset"
              class="px-3 py-2 rounded-lg bg-purple-900 hover:bg-purple-800 active:scale-95 transition"
              title="Reset (900 px)" aria-label="Reset">↺</button>
    </div>

    <p class="mt-2 text-[11px] leading-snug text-purple-300/80">
      Qisqa tugmalar: <kbd>+</kbd>/<kbd>-</kbd>, <kbd>0</kbd> (oldingi holiga qaytish), <kbd>P</kbd> (panel), <kbd>Esc</kbd> (yopish).
    </p>
  </div>

  <!-- ======== Scripts ======== -->
  <script>
    // CSRF (cookie'dan)
    function getCookie(name){
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }
    const CSRF = getCookie('csrftoken') || '{{ csrf_token }}';
  </script>

  <script>
    // -------- Reader width controls (persist) + IMG perf tweaks --------
    (function(){
      const KEY = 'reader.pageWidth';
      const MIN = 480, MAX = 1400, STEP = 20;

      function apply(px){
        var v = parseInt(px, 10);
        if (isNaN(v)) { v = 900; }
        if (v < MIN) { v = MIN; }
        if (v > MAX) { v = MAX; }
        document.documentElement.style.setProperty('--page-w', v + 'px');
        try { localStorage.setItem(KEY, v); } catch(e){}
        var out = document.getElementById('rcWidthOut'); if(out) out.textContent = v + 'px';
        var rng = document.getElementById('rcWidth');   if(rng) rng.value = v;
      }

      var saved = 900;
      try {
        var s = localStorage.getItem(KEY);
        if (s) { saved = parseInt(s, 10); }
      } catch(e){}
      apply(saved);

      window.__rcWMinus = function(){ apply((parseInt(localStorage.getItem(KEY)||'900',10)) - STEP); };
      window.__rcWPlus  = function(){ apply((parseInt(localStorage.getItem(KEY)||'900',10)) + STEP); };
      window.__rcWSet   = function(v){ apply(v); };

      // IMG attributes (lazy, async, first=high)
      var cont = document.getElementById('pageCol');
      if (cont){
        var imgs = cont.getElementsByTagName('img');
        if (imgs.length > 0){
          for (var i=0;i<imgs.length;i++){
            var im = imgs[i];
            if (!im.hasAttribute('loading')) im.setAttribute('loading','lazy');
            if (!im.hasAttribute('decoding')) im.setAttribute('decoding','async');
            if (!im.referrerPolicy) im.referrerPolicy = 'no-referrer';
            if (i === 0) {
              try { im.fetchPriority = 'high'; } catch(e){}
            }
          }
        }
      }
    })();
  </script>

  <script>
    // -------- Purchase modal helpers --------
    const mangaTitle = "{{ manga.title|escapejs }}";
    const BUY_URL_TPL  = "{% url 'manga:purchase_chapter' manga.slug 111 222 %}";
    const READ_URL_TPL = "{% url 'manga:chapter_read'    manga.slug 111 222 %}";

    const buyModal   = document.getElementById('buyModal');
    const buyBtn     = document.getElementById('buyBtn');
    const closeModal = document.getElementById('closeBuyModal');
    const modalTitle   = document.getElementById('modalTitle');
    const modalChapter = document.getElementById('modalChapter');
    const modalPrice   = document.getElementById('modalPrice');

    let targetBuyUrl = "";
    let targetReadUrl = "";

    function buildUrl(tpl, vol, ch) {
      return tpl.replace('/111/', '/' + vol + '/').replace('/222/', '/' + ch + '/');
    }

    function openPurchase(vol, ch, price) {
      modalTitle.textContent   = mangaTitle;
      modalChapter.textContent = ch;
      modalPrice.textContent   = price;
      targetBuyUrl  = buildUrl(BUY_URL_TPL,  vol, ch);
      targetReadUrl = buildUrl(READ_URL_TPL, vol, ch);
      buyModal.classList.remove('hidden');
      setTimeout(function(){ try{ buyBtn.focus(); }catch(e){} }, 90);
    }

    // Delegation: har qanday .js-open-purchase tugmasi
    document.addEventListener('click', function(e){
      var btn = e.target.closest('.js-open-purchase');
      if (!btn) return;
      openPurchase(btn.dataset.vol, btn.dataset.ch, btn.dataset.price);
    });

    closeModal.addEventListener('click', function(){ buyModal.classList.add('hidden'); });
    buyModal.addEventListener('click', function(e){ if (e.target === buyModal) buyModal.classList.add('hidden'); });

    buyBtn.addEventListener('click', async function(){
      const self = this;
      self.disabled = true;
      const oldHTML = self.innerHTML;
      self.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Jarayonda…</span>';
      try{
        const res  = await fetch(targetBuyUrl, {
          method: 'POST',
          headers: {'X-CSRFToken': CSRF, 'X-Requested-With': 'XMLHttpRequest'}
        });
        const data = await res.json();
        if (data.success) {
          self.innerHTML = '<i class="fas fa-check"></i> <span>Muvaffaqiyatli!</span>';
          setTimeout(function(){ window.location.href = targetReadUrl; }, 700);
        } else {
          self.innerHTML = oldHTML;
          alert(data.message || 'Xatolik yuz berdi, qayta urinib ko‘ring.');
          self.disabled = false;
        }
      } catch(err){
        console.error(err);
        self.innerHTML = oldHTML;
        alert('Tarmoq xatosi. Internet aloqasini tekshiring.');
        self.disabled = false;
      }
    });
  </script>

  <script>
    // -------- Thank toggle --------
    (function(){
      var th = document.getElementById('thankBtn');
      if (!th) return;
      th.addEventListener('click', async function(){
        var btn = this;
        var id  = btn.dataset.chapterId;
        var url = "{% url 'manga:thank_chapter' 0 %}".replace('/0/', '/' + id + '/');

        try{
          const res = await fetch(url, {
            method:'POST',
            headers:{'X-CSRFToken': CSRF,'X-Requested-With':'XMLHttpRequest'}
          });
          const data = await res.json();
          var thanked = data.thanked;
          var count   = data.count;
          var icon   = btn.querySelector('.fa-heart');
          var textEl = btn.querySelector('#thankText');
          var cntEl  = btn.querySelector('#thankCount');

          if (thanked) { icon.classList.add('text-red-400'); }
          else { icon.classList.remove('text-red-400'); }
          if (textEl) textEl.textContent = thanked ? 'Rahmat aytildi' : 'Rahmat aytish';
          if (cntEl)  cntEl.textContent  = '(' + count + ')';
        }catch(err){
          console.error('Thank error:', err);
        }
      });
    })();
  </script>

  <!-- Chapter sidebar -->
  <script>
    // -------- Chapters Sidebar open/close + sort + auto-scroll to current --------
    (function () {
      var root  = document.getElementById('chapSidebar');
      var panel = document.getElementById('chapPanel');
      var mask  = document.getElementById('chapMask');
      var btnO  = document.getElementById('openChaps');
      var btnC  = document.getElementById('closeChaps');
      var chapList = document.getElementById('chapList');
      var btnSortAsc  = document.getElementById('chapSortAsc');
      var btnSortDesc = document.getElementById('chapSortDesc');

      if (!root || !panel) return;

      var previouslyFocused = null;

      /* ======== 1–10 / 10–1 tartiblash ======== */
      var SORT_KEY = 'manga:chapSortOrder';
      var items = chapList ? Array.from(chapList.children) : [];
      var ascItems = items.slice().reverse();
      var sortOrder = 'desc'; // default: 10 → 1 (yangi boblar tepada)

      function loadSort(){
        try{
          var s = localStorage.getItem(SORT_KEY);
          if (s === 'asc' || s === 'desc') sortOrder = s;
        }catch(e){}
      }
      function saveSort(){
        try{ localStorage.setItem(SORT_KEY, sortOrder); }catch(e){}
      }

      function updateSortButtons(){
        if (!btnSortAsc || !btnSortDesc) return;
        if (sortOrder === 'asc'){
          btnSortAsc.classList.add('bg-purple-800','text-white');
          btnSortAsc.classList.remove('bg-transparent','text-purple-300');
          btnSortDesc.classList.remove('bg-purple-800','text-white');
          btnSortDesc.classList.add('bg-transparent','text-purple-300');
        } else {
          btnSortDesc.classList.add('bg-purple-800','text-white');
          btnSortDesc.classList.remove('bg-transparent','text-purple-300');
          btnSortAsc.classList.remove('bg-purple-800','text-white');
          btnSortAsc.classList.add('bg-transparent','text-purple-300');
        }
      }

      function applySort(order){
        if (!chapList || !items.length) return;
        sortOrder = (order === 'asc') ? 'asc' : 'desc';
        saveSort();
        chapList.innerHTML = '';
        var arr = (sortOrder === 'asc') ? ascItems : items;
        arr.forEach(function(li){ chapList.appendChild(li); });
        updateSortButtons();
      }

      loadSort();
      applySort(sortOrder);

      if (btnSortAsc){
        btnSortAsc.addEventListener('click', function(){
          applySort('asc');
        });
      }
      if (btnSortDesc){
        btnSortDesc.addEventListener('click', function(){
          applySort('desc');
        });
      }

      /* ======== Sidebar open/close ======== */
      function scrollToCurrent() {
        try {
          // data-current="1" bo'lmasa ham ishlashi uchun fallback:
          var cur = panel.querySelector('[data-current="1"], a[aria-current="page"], button[aria-current="page"]');
          if (cur && cur.scrollIntoView) {
            cur.scrollIntoView({ block: 'center', inline: 'nearest', behavior: 'smooth' });
          }
        } catch (e) {}
      }

      function open() {
        previouslyFocused = document.activeElement || null;
        root.classList.remove('hidden');
        root.removeAttribute('aria-hidden');

        // slide-in
        requestAnimationFrame(function () {
          panel.style.transform = 'translateX(0)';
        });

        if (btnO) btnO.setAttribute('aria-expanded', 'true');
        document.body.style.overflow = 'hidden';

        // Layout joyiga tushgach – current itemga scroll + fokus close tugmaga
        setTimeout(function () {
          scrollToCurrent();
          if (btnC && typeof btnC.focus === 'function') btnC.focus();
          window.dispatchEvent(new CustomEvent('manga:chapPanelOpened'));
        }, 120);
      }

      function close() {
        panel.style.transform = 'translateX(-100%)';
        if (btnO) btnO.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
        root.setAttribute('aria-hidden', 'true');

        // CSS transition (~300ms) tugagach to'liq yashiramiz
        setTimeout(function () {
          root.classList.add('hidden');
          if (previouslyFocused && typeof previouslyFocused.focus === 'function') {
            previouslyFocused.focus();
          }
          window.dispatchEvent(new CustomEvent('manga:chapPanelClosed'));
        }, 280);
      }

      // Triggers
      if (btnO) btnO.addEventListener('click', open);
      if (btnC) btnC.addEventListener('click', close);
      if (mask) mask.addEventListener('click', close);

      // Esc bilan yopish
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && !root.classList.contains('hidden')) close();
      });

      // Ochiq holatda rezayz bo'lsa – current itemni qayta markazga keltiramiz
      window.addEventListener('resize', function () {
        if (!root.classList.contains('hidden')) setTimeout(scrollToCurrent, 60);
      });
    })();
  </script>

  <!-- Panel -->
  <script>
  (function () {
    var rcBtn   = document.getElementById('rcToggleBtn');
    var rcPanel = document.getElementById('rcPanel');
    var rcClose = document.getElementById('rcClose');
    var elMinus = document.getElementById('rcMinus');
    var elPlus  = document.getElementById('rcPlus');
    var elReset = document.getElementById('rcReset');
    var elOut   = document.getElementById('rcWidthOut');
    var elMeter = document.getElementById('rcMeter');

    var STEP = 20;
    var MIN_W = 480, MAX_W = 1080;
    var DEFAULT_W = 900;
    var BARS = 12, bars = [];
    var scrubbing = false;

    function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
    function roundStep(n){ return Math.round(n/STEP)*STEP; }
    function key(){ return 'reader:'+ location.pathname; }
    function getTargetEl(){
      var sel = rcPanel ? rcPanel.getAttribute('data-rc-target') : null;
      return (sel && document.querySelector(sel)) || document.getElementById('pageCol') || document.documentElement;
    }

    var state = { widthPx: DEFAULT_W };

    function load(){
      try{ var raw = localStorage.getItem(key());
        if(!raw) return; var s = JSON.parse(raw);
        if(s && typeof s==='object' && s.widthPx) state.widthPx = s.widthPx;
      }catch(e){}
    }
    function persist(){ try{ localStorage.setItem(key(), JSON.stringify(state)); }catch(e){} }

    function buildMeter(){
      if(!elMeter) return; elMeter.innerHTML=''; bars=[];
      for(var i=0;i<BARS;i++){
        var bar=document.createElement('span'); bar.className='rc-bar';
        bar.style.height = (20 + (i/(BARS-1))*70) + '%'; // 20%→90%
        elMeter.appendChild(bar); bars.push(bar);
      }
    }

    function updateMeter(){
      if(!bars.length) return;
      var p = (state.widthPx - MIN_W) / (MAX_W - MIN_W);
      p = clamp(p,0,1);
      var active = Math.round(p * BARS);
      bars.forEach(function(bar, idx){
        var on = idx < active;
        bar.classList.toggle('on', on);
        if(on){ bar.classList.add('bump'); setTimeout(function(){ bar.classList.remove('bump'); }, 250); }
      });
      elMeter.setAttribute('aria-valuenow', String(state.widthPx));
    }

    function applyWidth(px){
      var t = getTargetEl();
      t.style.setProperty('--page-w', px + 'px');
      t.style.setProperty('--page-gap','0px'); // doim 0
    }

    function updateUI(){
      state.widthPx = clamp(roundStep(state.widthPx), MIN_W, MAX_W);
      elOut.textContent = state.widthPx + ' px';
      applyWidth(state.widthPx); persist(); updateMeter();
    }

    function initFromComputed(){
      var t = getTargetEl();
      var cur = getComputedStyle(t).getPropertyValue('--page-w');
      var w = parseInt(cur,10);
      if(!Number.isNaN(w)) state.widthPx = clamp(w, MIN_W, MAX_W);
      t.style.setProperty('--page-gap','0px');
    }

    // Panel open/close (telefonda ham ishlaydi)
    function openPanel(){ rcPanel.classList.remove('hidden'); rcBtn && rcBtn.setAttribute('aria-expanded','true'); }
    function closePanel(){ rcPanel.classList.add('hidden'); rcBtn && rcBtn.setAttribute('aria-expanded','false'); }
    function togglePanel(){ rcPanel.classList.contains('hidden') ? openPanel() : closePanel(); }

    // Tashqi funksiya
    window.__rcWPlus  = function(){ state.widthPx = clamp(state.widthPx + STEP, MIN_W, MAX_W); updateUI(); };
    window.__rcWMinus = function(){ state.widthPx = clamp(state.widthPx - STEP, MIN_W, MAX_W); updateUI(); };

    // Meter: click/drag/wheel
    function setFromMeterClientX(clientX){
      var rect = elMeter.getBoundingClientRect();
      var r = (clientX - rect.left) / rect.width; r = clamp(r,0,1);
      state.widthPx = roundStep(MIN_W + r * (MAX_W - MIN_W));
      updateUI();
    }
    elMeter.addEventListener('pointerdown', function(e){
      scrubbing = true; elMeter.setPointerCapture(e.pointerId); setFromMeterClientX(e.clientX);
    });
    elMeter.addEventListener('pointermove', function(e){ if(scrubbing) setFromMeterClientX(e.clientX); });
    elMeter.addEventListener('pointerup',   function(e){ scrubbing=false; try{ elMeter.releasePointerCapture(e.pointerId); }catch(_){}} );
    elMeter.addEventListener('wheel', function(e){
      e.preventDefault(); (e.deltaY < 0) ? window.__rcWPlus() : window.__rcWMinus();
    }, {passive:false});

    // Buttons
    elMinus && elMinus.addEventListener('click', function(){ __rcWMinus(); });
    elPlus  && elPlus.addEventListener('click',  function(){ __rcWPlus();  });
    elReset && elReset.addEventListener('click', function(){ state.widthPx = DEFAULT_W; updateUI(); });

    // Panel toggling & close
    rcBtn  && rcBtn.addEventListener('click', function(e){ e.stopPropagation(); togglePanel(); });
    rcClose&& rcClose.addEventListener('click', function(){ closePanel(); });
    document.addEventListener('click', function(e){
      if(!rcPanel) return;
      var inside = e.target.closest('#rcPanel') || e.target.closest('#rcToggleBtn');
      if(!inside) closePanel();
    });

    // Keyboard
    document.addEventListener('keydown', function(e){
      var tag=(e.target&&e.target.tagName||'').toLowerCase();
      if(['input','textarea','select'].includes(tag)) return;
      if(e.key==='+'||e.key==='='){ e.preventDefault(); __rcWPlus(); }
      if(e.key==='-'||e.key==='_'){ e.preventDefault(); __rcWMinus(); }
      if(e.key==='0'){ e.preventDefault(); state.widthPx = DEFAULT_W; updateUI(); }
      if(e.key.toLowerCase()==='p'){ e.preventDefault(); togglePanel(); }
      if(e.key==='Escape'){ closePanel(); }
    });

    // Init
    load(); initFromComputed(); buildMeter(); updateUI(); closePanel();
  })();
  </script>

  <!-- ======== Sticky Navbar click-toggling ======== -->
  <script>
  /* Navbar: faqat bosishda toggle; scrollga javob bermaydi */
  (function(){
  var nav    = document.getElementById('navbar');
  var reader = document.getElementById('reader') || document.body;
  if (!nav) return;

  var HIDDEN = false;

  function showNav(){
    nav.style.transform = 'translateY(0)';
    nav.setAttribute('aria-hidden','false');
    HIDDEN = false;
  }
  function hideNav(){
    nav.style.transform = 'translateY(-100%)';
    nav.setAttribute('aria-hidden','true');
    HIDDEN = true;
  }
  function toggleNav(){
    (HIDDEN ? showNav() : hideNav());
  }

  // Default: ochiq
  showNav();

  // Faqat ekranga (reader) bosilganda toggle
  reader.addEventListener('click', function(e){
    // Interaktiv elementlarga bosilganda togglemaymiz
    var tag = (e.target.tagName || '').toLowerCase();
    if (['a','button','input','select','textarea','label','summary','video'].includes(tag)) return;

    // Modal/Sidebar/panel ichida bosilsa togglemaymiz
    if (e.target.closest('#chapSidebar') || e.target.closest('#rcPanel') || e.target.closest('#buyModal')) return;

    // Matn tanlanayotgan bo'lsa togglemaymiz
    if (window.getSelection && String(window.getSelection())) return;

    toggleNav();
  });

  // Navbar ichida bosilganda toggle bo‘lmasin
  nav.addEventListener('click', function(e){ e.stopPropagation(); });

  // Eslatma: scroll event umuman yo‘q — faqat click bilan ishlaydi
  })();
  </script>

<style>
  .rc-meter{ cursor: ew-resize; user-select:none; }
  .rc-bar{
    width: 6px;
    background: linear-gradient(180deg,#c4b5fd 0%, #a78bfa 40%, #7c3aed 100%);
    opacity: .35;
    border-radius: 9999px;
    transition: height .18s ease, opacity .18s ease, filter .18s ease, transform .18s ease;
    transform: translateZ(0);
  }
  .rc-bar.on{ opacity:1; filter: drop-shadow(0 0 4px rgba(167,139,250,.45)); }
  .rc-bar.bump{ animation: rc-bump .22s ease; }
  @keyframes rc-bump{ 0%{transform:translateY(0)} 40%{transform:translateY(-3px)} 100%{transform:translateY(0)} }

  /* ==== Boblar scrollbari – ingichka va kam ko‘rinadigan ==== */
  #chapScroll{
    scrollbar-width: thin;                          /* Firefox */
    scrollbar-color: rgba(167,139,250,.7) transparent;
  }

  /* Chrome / Edge / Safari */
  #chapScroll::-webkit-scrollbar{
    width: 7px;
  }
  #chapScroll::-webkit-scrollbar-track{
    background: transparent;                        /* oq/qora ustun yo‘qoladi */
  }
  #chapScroll::-webkit-scrollbar-thumb{
    background: rgba(167,139,250,.7);               /* mayin purple */
    border-radius: 9999px;
  }
</style>



</body>
</html>
